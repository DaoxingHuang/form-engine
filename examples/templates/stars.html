<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D æŠ½å¥–æ˜Ÿçƒ (Lottery Planet)</title>
    <!-- å¼•å…¥ Tailwind CSS è¿›è¡Œå¿«é€Ÿ UI æ ·å¼å¼€å‘ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- å¼•å…¥ TWEEN.js ç”¨äºå¹³æ»‘åŠ¨ç”» -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #050510;
        font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }
      #canvas-container {
        width: 100vw;
        height: 100vh;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      }

      /* UI å±‚çº§åœ¨ Canvas ä¹‹ä¸Š */
      #ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none;
      }
      .interactive {
        pointer-events: auto;
      }

      /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
      .glass-panel {
        background: rgba(20, 30, 60, 0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
      }

      /* å€’è®¡æ—¶åŠ¨ç”» */
      @keyframes pulse-scale {
        0% {
          transform: scale(0.8);
          opacity: 0;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 0;
        }
      }
      .countdown-anim {
        animation: pulse-scale 0.8s ease-out forwards;
      }

      /* éœ“è™¹å‘å…‰æ–‡å­— */
      .neon-text {
        text-shadow:
          0 0 10px rgba(0, 255, 255, 0.7),
          0 0 20px rgba(0, 255, 255, 0.5);
      }
    </style>
  </head>
  <body>
    <!-- 3D å®¹å™¨ -->
    <div id="canvas-container"></div>

    <!-- UI äº¤äº’å±‚ -->
    <div id="ui-layer" class="flex flex-col justify-between p-6">
      <!-- é¡¶éƒ¨ï¼šçŠ¶æ€æ  -->
      <div class="flex justify-between items-start">
        <div class="glass-panel p-4 rounded-xl text-white interactive">
          <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-purple-500">
            LOTTERY PLANET
          </h1>
          <div class="text-xs text-gray-400 mt-1">
            å½“å‰å‚ä¸äººæ•°: <span id="user-count" class="text-cyan-300">0</span>
          </div>
          <div class="mt-2 flex items-center gap-2">
            <div id="status-dot" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span id="status-text" class="text-sm font-mono text-gray-300">READY</span>
          </div>
        </div>

        <!-- è®¾ç½®/æ¨¡å¼å¼€å…³ (æ¨¡æ‹Ÿ) -->
        <div class="glass-panel p-2 rounded-lg flex gap-2 interactive">
          <button class="p-2 hover:bg-white/10 rounded text-gray-300 text-xs" title="è®¾ç½®">âš™ï¸</button>
          <button class="p-2 hover:bg-white/10 rounded text-gray-300 text-xs" title="å…¨å±" onclick="toggleFullScreen()">
            â›¶
          </button>
        </div>
      </div>

      <!-- ä¸­å¿ƒï¼šå€’è®¡æ—¶æ˜¾ç¤º -->
      <div
        id="countdown-display"
        class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-9xl font-black text-white hidden z-50 neon-text"
      >
        3
      </div>

      <!-- åº•éƒ¨ï¼šæ§åˆ¶æ  -->
      <div class="flex justify-center items-end pb-8">
        <div class="glass-panel px-6 py-4 rounded-full flex gap-4 interactive items-center">
          <!-- å¼€å§‹/æŠ½å¥–æŒ‰é’® -->
          <button
            id="btn-start"
            class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105 active:scale-95 flex items-center gap-2"
          >
            <span class="text-xl">ğŸš€</span> å¼€å§‹æŠ½å¥–
          </button>

          <!-- æš‚åœ/ç»§ç»­ -->
          <button
            id="btn-pause"
            class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow transition hidden"
          >
            â¸ æš‚åœ
          </button>

          <!-- åœæ­¢/è·³è¿‡ -->
          <button
            id="btn-stop"
            class="bg-red-600/80 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-full shadow transition hidden"
          >
            â¹ åœæ­¢
          </button>

          <!-- æ¨¡æ‹Ÿæ·»åŠ æ•°æ® -->
          <div class="w-px h-8 bg-gray-600 mx-2"></div>
          <button onclick="resetCamera()" class="text-gray-400 hover:text-white text-sm">é‡ç½®è§†è§’</button>
        </div>
      </div>
    </div>

    <!-- ç»“æœå¼¹çª— (Modal) -->
    <div
      id="result-modal"
      class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm"
    >
      <div
        class="glass-panel p-1 rounded-2xl max-w-md w-full mx-4 transform transition-all scale-95 opacity-0"
        id="result-card"
      >
        <div class="bg-gradient-to-br from-indigo-900 to-black rounded-xl p-8 text-center relative overflow-hidden">
          <!-- è£…é¥°å…‰æ•ˆ -->
          <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500"></div>

          <h2
            class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500 mb-6"
          >
            ğŸ‰ æ­å–œä¸­å¥–ï¼
          </h2>

          <div class="relative inline-block mb-6">
            <div class="absolute inset-0 bg-blue-500 rounded-full blur-xl opacity-50 animate-pulse"></div>
            <img
              id="winner-avatar"
              src=""
              class="w-24 h-24 rounded-full border-4 border-white relative z-10 bg-gray-800 object-cover"
            />
          </div>

          <h3 id="winner-name" class="text-2xl text-white font-bold mb-2">Unknown</h3>
          <p id="winner-id" class="text-blue-300 mb-6">ID: 888888</p>

          <div class="bg-white/10 rounded-lg p-4 mb-6">
            <p class="text-gray-300 text-sm mb-1">å¥–é¡¹</p>
            <p class="text-xl font-bold text-yellow-400">âœ¨ ç‰¹ç­‰å¥–ï¼šç¥ç§˜å¤§ç¤¼åŒ…</p>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <button
              onclick="closeResult()"
              class="border border-white/20 hover:bg-white/10 text-white py-2 rounded-lg transition"
            >
              ç»§ç»­æŠ½å¥–
            </button>
            <button
              onclick="alert('ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼')"
              class="bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg transition"
            >
              åˆ†äº«ç»“æœ
            </button>
          </div>

          <!-- å…³é—­æŒ‰é’® -->
          <button onclick="closeResult()" class="absolute top-3 right-3 text-gray-500 hover:text-white">âœ•</button>
        </div>
      </div>
    </div>

    <script>
      /**
       * 1. åˆå§‹åŒ–ä¸é…ç½®
       */
      const CONFIG = {
        cardCount: 200, // æ˜Ÿçƒä¸Šçš„å¡ç‰‡æ•°é‡
        radius: 600, // æ˜ŸçƒåŠå¾„
        cardWidth: 60, // å¡ç‰‡å®½åº¦
        cardHeight: 35, // å¡ç‰‡é«˜åº¦
        spinSpeedMax: 0.08, // æœ€å¤§æ—‹è½¬é€Ÿåº¦
        spinAccel: 0.001, // åŠ é€Ÿåº¦
        spinDecel: 0.0005 // å‡é€Ÿåº¦ (è‡ªç„¶åœæ­¢ç”¨ï¼Œè¿™é‡Œä¸»è¦ç”¨ Tween å¼ºåˆ¶å®šä½)
      };

      const STATE = {
        IDLE: 0,
        COUNTDOWN: 1,
        SPINNING: 2,
        PAUSED: 3,
        STOPPING: 4,
        RESULT: 5
      };

      let currentState = STATE.IDLE;
      let scene, camera, renderer;
      let planetGroup = new THREE.Group(); // æ‰¿è½½æ‰€æœ‰å¡ç‰‡çš„å®¹å™¨
      let cards = []; // å­˜å‚¨å¡ç‰‡ç½‘æ ¼å¯¹è±¡
      let particles; // ç²’å­ç³»ç»Ÿ
      let currentSpinSpeed = 0;
      let isSpinning = false;
      let animationId;

      // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
      const generateUsers = (count) => {
        const users = [];
        const depts = ["æŠ€æœ¯éƒ¨", "è®¾è®¡éƒ¨", "è¿è¥éƒ¨", "äº§å“éƒ¨", "å¸‚åœºéƒ¨"];
        for (let i = 0; i < count; i++) {
          users.push({
            id: 1000 + i,
            name: `User_${Math.floor(Math.random() * 9000) + 1000}`,
            dept: depts[Math.floor(Math.random() * depts.length)],
            avatarColor: `hsl(${Math.random() * 360}, 70%, 60%)` // éšæœºé¢œè‰²å¤´åƒ
          });
        }
        return users;
      };
      const users = generateUsers(CONFIG.cardCount);

      /**
       * 2. çº¹ç†ç”Ÿæˆ (ä½¿ç”¨ Canvas ç»˜åˆ¶ç±»ä¼¼å›¾ç‰‡çš„å¡ç‰‡)
       */
      function createCardTexture(user) {
        const canvas = document.createElement("canvas");
        canvas.width = 256;
        canvas.height = 140;
        const ctx = canvas.getContext("2d");

        // èƒŒæ™¯ï¼šæ·±è‰²åŠé€æ˜æ¸å˜
        const gradient = ctx.createLinearGradient(0, 0, 256, 140);
        gradient.addColorStop(0, "rgba(20, 30, 80, 0.9)");
        gradient.addColorStop(1, "rgba(40, 10, 60, 0.9)");

        // åœ†è§’çŸ©å½¢èƒŒæ™¯
        ctx.fillStyle = gradient;
        ctx.strokeStyle = "rgba(100, 200, 255, 0.3)";
        ctx.lineWidth = 4;

        // ç®€å•ç»˜åˆ¶åœ†è§’çŸ©å½¢
        ctx.beginPath();
        ctx.roundRect(5, 5, 246, 130, 15);
        ctx.fill();
        ctx.stroke();

        // å¤´åƒ (å·¦ä¾§åœ†åœˆ)
        ctx.beginPath();
        ctx.arc(60, 70, 35, 0, Math.PI * 2);
        ctx.fillStyle = user.avatarColor;
        ctx.fill();
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 3;
        ctx.stroke();

        // æ–‡å­—ï¼šåå­—
        ctx.fillStyle = "#ffffff";
        ctx.font = "bold 36px Arial";
        ctx.fillText(user.name, 110, 70);

        // æ–‡å­—ï¼šéƒ¨é—¨
        ctx.fillStyle = "#aaddff";
        ctx.font = "24px Arial";
        ctx.fillText(user.dept, 110, 105);

        const texture = new THREE.CanvasTexture(canvas);
        return texture;
      }

      /**
       * 3. Three.js åœºæ™¯æ„å»º
       */
      function init() {
        // åœºæ™¯
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050510, 0.0008); // è¿œå¤„é›¾åŒ–ï¼Œå¢åŠ æ·±åº¦æ„Ÿ

        // ç›¸æœº
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 5000);
        camera.position.z = 1200; // åˆå§‹è·ç¦»

        // æ¸²æŸ“å™¨
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById("canvas-container").appendChild(renderer.domElement);

        // ç¯å…‰
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const pointLight = new THREE.PointLight(0x00ffff, 1, 2000);
        pointLight.position.set(500, 500, 500);
        scene.add(pointLight);

        // ä¸­å¿ƒå‘å…‰çƒä½“ (æ˜Ÿçƒæ ¸å¿ƒ)
        const coreGeometry = new THREE.SphereGeometry(CONFIG.radius - 20, 32, 32);
        const coreMaterial = new THREE.MeshBasicMaterial({
          color: 0x001133,
          transparent: true,
          opacity: 0.8,
          wireframe: true // ç½‘æ ¼çº¿æ›´æœ‰ç§‘æŠ€æ„Ÿ
        });
        const core = new THREE.Mesh(coreGeometry, coreMaterial);
        planetGroup.add(core);

        // ç”Ÿæˆå¡ç‰‡ (Fibonacci Sphere Algorithm)
        const phi = Math.PI * (3 - Math.sqrt(5)); // é»„é‡‘è§’

        users.forEach((user, i) => {
          const y = 1 - (i / (users.length - 1)) * 2; // y ä» 1 åˆ° -1
          const radiusAtY = Math.sqrt(1 - y * y); // åŠå¾„åœ¨ y å¤„çš„åˆ‡é¢
          const theta = phi * i; // é»„é‡‘è§’å¢é‡

          const x = Math.cos(theta) * radiusAtY;
          const z = Math.sin(theta) * radiusAtY;

          // è®¡ç®—ä½ç½®
          const position = new THREE.Vector3(x, y, z).multiplyScalar(CONFIG.radius);

          // åˆ›å»º Mesh
          const geometry = new THREE.PlaneGeometry(CONFIG.cardWidth, CONFIG.cardHeight);
          const material = new THREE.MeshBasicMaterial({
            map: createCardTexture(user),
            side: THREE.DoubleSide,
            transparent: true
          });

          const card = new THREE.Mesh(geometry, material);
          card.position.copy(position);
          card.lookAt(0, 0, 0); // é¢å‘çƒå¿ƒ (æˆ–è€…åè¿‡æ¥)
          card.userData = { id: user.id, data: user, originalPos: position.clone() }; // ç»‘å®šæ•°æ®

          planetGroup.add(card);
          cards.push(card);
        });

        scene.add(planetGroup);

        // æ·»åŠ èƒŒæ™¯ç²’å­æ˜Ÿç©º
        createStarfield();

        // ç›‘å¬çª—å£ç¼©æ”¾
        window.addEventListener("resize", onWindowResize, false);

        // å¯åŠ¨åŠ¨ç”»å¾ªç¯
        animate();

        // æ›´æ–° UI
        document.getElementById("user-count").innerText = users.length;
      }

      function createStarfield() {
        const geometry = new THREE.BufferGeometry();
        const vertices = [];
        for (let i = 0; i < 1000; i++) {
          vertices.push(
            THREE.MathUtils.randFloatSpread(4000),
            THREE.MathUtils.randFloatSpread(4000),
            THREE.MathUtils.randFloatSpread(4000)
          );
        }
        geometry.setAttribute("position", new THREE.Float32BufferAttribute(vertices, 3));
        const material = new THREE.PointsMaterial({ color: 0x888888, size: 2 });
        const stars = new THREE.Points(geometry, material);
        scene.add(stars);
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      /**
       * 4. åŠ¨ç”»å¾ªç¯
       */
      function animate(time) {
        requestAnimationFrame(animate);
        TWEEN.update(time);

        // æ—‹è½¬é€»è¾‘
        if (currentState === STATE.SPINNING) {
          // åŠ é€Ÿé˜¶æ®µ
          if (currentSpinSpeed < CONFIG.spinSpeedMax) {
            currentSpinSpeed += CONFIG.spinAccel;
          }
        } else if (currentState === STATE.PAUSED) {
          currentSpinSpeed = 0;
        } else if (currentState === STATE.STOPPING) {
          // å‡é€Ÿé€»è¾‘ç”± Tween æ¥ç®¡ï¼Œè¿™é‡Œä¸éœ€è¦åš
        } else {
          // ç©ºé—²è‡ªè½¬ (éå¸¸æ…¢)
          currentSpinSpeed = 0.002;
        }

        // åº”ç”¨æ—‹è½¬
        if (currentState !== STATE.RESULT && currentState !== STATE.STOPPING) {
          planetGroup.rotation.y -= currentSpinSpeed;
          planetGroup.rotation.x = Math.sin(time * 0.0005) * 0.1; // è½»å¾®ä¸Šä¸‹æ‘†åŠ¨
        }

        // æ¸²æŸ“
        renderer.render(scene, camera);
      }

      /**
       * 5. äº¤äº’é€»è¾‘
       */
      const btnStart = document.getElementById("btn-start");
      const btnPause = document.getElementById("btn-pause");
      const btnStop = document.getElementById("btn-stop");
      const statusText = document.getElementById("status-text");
      const statusDot = document.getElementById("status-dot");
      const countdownEl = document.getElementById("countdown-display");
      const modal = document.getElementById("result-modal");
      const modalCard = document.getElementById("result-card");

      // å¼€å§‹æŠ½å¥–
      btnStart.addEventListener("click", () => {
        if (currentState === STATE.SPINNING) return;
        startCountdown();
      });

      // æš‚åœ
      btnPause.addEventListener("click", () => {
        if (currentState === STATE.SPINNING) {
          currentState = STATE.PAUSED;
          updateStatus("PAUSED", "bg-yellow-500");
          btnPause.innerHTML = "â–¶ ç»§ç»­";
        } else if (currentState === STATE.PAUSED) {
          currentState = STATE.SPINNING;
          updateStatus("SPINNING...", "bg-blue-500");
          btnPause.innerHTML = "â¸ æš‚åœ";
        }
      });

      // åœæ­¢/å¼€å¥–
      btnStop.addEventListener("click", () => {
        if (currentState === STATE.SPINNING || currentState === STATE.PAUSED) {
          stopLottery();
        }
      });

      function updateStatus(text, colorClass) {
        statusText.innerText = text;
        statusDot.className = `w-2 h-2 rounded-full animate-pulse ${colorClass}`;
      }

      function startCountdown() {
        currentState = STATE.COUNTDOWN;
        updateStatus("PREPARING", "bg-yellow-500");

        // éšè—å¼€å§‹æŒ‰é’®ï¼Œæ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
        btnStart.classList.add("hidden");

        let count = 3;
        countdownEl.classList.remove("hidden");

        const timer = setInterval(() => {
          countdownEl.innerText = count;
          // æ·»åŠ åŠ¨ç”»ç±»è§¦å‘ CSS åŠ¨ç”»
          countdownEl.classList.remove("countdown-anim");
          void countdownEl.offsetWidth; // trigger reflow
          countdownEl.classList.add("countdown-anim");

          if (count <= 0) {
            clearInterval(timer);
            countdownEl.classList.add("hidden");
            startSpinning();
          }
          count--;
        }, 800);
      }

      function startSpinning() {
        currentState = STATE.SPINNING;
        updateStatus("SPINNING...", "bg-blue-500");
        btnPause.classList.remove("hidden");
        btnStop.classList.remove("hidden");

        // æ¢å¤ç›¸æœºä½ç½®ï¼ˆå¦‚æœä¹‹å‰è¢«ç§»åŠ¨è¿‡ï¼‰
        new TWEEN.Tween(camera.position).to({ x: 0, y: 0, z: 1200 }, 1000).easing(TWEEN.Easing.Quadratic.Out).start();
      }

      function stopLottery() {
        currentState = STATE.STOPPING;
        updateStatus("LUCKY WINNER...", "bg-purple-500");
        btnPause.classList.add("hidden");
        btnStop.classList.add("hidden");

        // 1. éšæœºé€‰æ‹©ä¸€ä¸ªä¸­å¥–è€…
        const winnerIndex = Math.floor(Math.random() * cards.length);
        const winnerCard = cards[winnerIndex];
        const winnerData = winnerCard.userData.data;

        // 2. è®¡ç®—å¡ç‰‡çš„ä¸–ç•Œä½ç½®
        // ä¸ºäº†è®©ç›¸æœºå¯¹å‡†å®ƒï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—æ˜Ÿçƒæ—‹è½¬åçš„å®é™…ä¸–ç•Œåæ ‡
        // ä½†æ›´ç®€å•çš„æ–¹æ³•æ˜¯ï¼šæŠŠæ˜Ÿçƒæ—‹è½¬åˆ°è®©è¯¥å¡ç‰‡æ­£å¯¹ç›¸æœº
        // è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨æ›´æœ‰è¶£çš„æ–¹æ³•ï¼šç›¸æœºé£å‘å¡ç‰‡

        // è·å–å¡ç‰‡å½“å‰çš„ä¸–ç•Œä½ç½® (World Position)
        winnerCard.updateWorldMatrix(true, false);
        const targetPos = new THREE.Vector3();
        winnerCard.getWorldPosition(targetPos);

        // 3. è®¡ç®—ç›¸æœºç›®æ ‡ä½ç½® (å¡ç‰‡å‰æ–¹ä¸€æ®µè·ç¦»)
        const cameraEndPos = targetPos
          .clone()
          .normalize()
          .multiplyScalar(CONFIG.radius + 300); // è·ç¦»çƒå¿ƒ R+300 å¤„

        // 4. åŠ¨ç”»åºåˆ—

        // æ­¥éª¤ A: å‡é€Ÿæ—‹è½¬æ˜Ÿçƒç›´åˆ°åœæ­¢ (æˆ–è€…ç›´æ¥ç”¨ç›¸æœºè¿½è¸ª)
        // è®©æˆ‘ä»¬åšä¸€ä¸ªç®€å•çš„æ•ˆæœï¼šæ˜Ÿçƒæ…¢æ…¢åœä¸‹ï¼ŒåŒæ—¶ç›¸æœºç§»åŠ¨

        new TWEEN.Tween(planetGroup.rotation)
          .to({ y: planetGroup.rotation.y - 0.5 }, 1000) // å†è½¬ä¸€ç‚¹ç‚¹
          .easing(TWEEN.Easing.Cubic.Out)
          .start();

        // æ­¥éª¤ B: ç›¸æœºç§»åŠ¨å¹¶ LookAt
        new TWEEN.Tween(camera.position)
          .to({ x: cameraEndPos.x, y: cameraEndPos.y, z: cameraEndPos.z }, 2000)
          .easing(TWEEN.Easing.Exponential.InOut)
          .onUpdate(() => {
            camera.lookAt(targetPos);
          })
          .onComplete(() => {
            // åˆ°è¾¾ä½ç½®åï¼Œé«˜äº®å¡ç‰‡
            highlightWinner(winnerCard);
            showResultModal(winnerData);
          })
          .start();
      }

      function highlightWinner(card) {
        // æ”¾å¤§å¡ç‰‡
        new TWEEN.Tween(card.scale).to({ x: 2.5, y: 2.5 }, 500).easing(TWEEN.Easing.Back.Out).start();

        // æ·»åŠ å…‰æ™•ç‰¹æ•ˆ (ç®€å•çš„ Mesh å åŠ )
        const glowGeo = new THREE.PlaneGeometry(100, 100);
        const glowMat = new THREE.MeshBasicMaterial({
          color: 0xffaa00,
          transparent: true,
          opacity: 0,
          side: THREE.DoubleSide
        });
        const glow = new THREE.Mesh(glowGeo, glowMat);
        glow.position.z = -1; // æ”¾åœ¨å¡ç‰‡åé¢
        card.add(glow);

        new TWEEN.Tween(glowMat).to({ opacity: 0.6 }, 500).yoyo(true).repeat(5).start();

        // ç®€å•çš„ç²’å­çˆ†ç‚¸ (è§†è§‰ä¸Š)
        createExplosion(card.getWorldPosition(new THREE.Vector3()));
      }

      function createExplosion(position) {
        const particleCount = 50;
        const geometry = new THREE.BufferGeometry();
        const positions = [];
        const velocities = [];

        for (let i = 0; i < particleCount; i++) {
          positions.push(position.x, position.y, position.z);
          velocities.push((Math.random() - 0.5) * 10, (Math.random() - 0.5) * 10, (Math.random() - 0.5) * 10);
        }

        geometry.setAttribute("position", new THREE.Float32BufferAttribute(positions, 3));
        const material = new THREE.PointsMaterial({ color: 0xffd700, size: 8, transparent: true });
        const particles = new THREE.Points(geometry, material);
        scene.add(particles);

        // ç²’å­åŠ¨ç”»
        const animateParticles = () => {
          const positions = particles.geometry.attributes.position.array;
          for (let i = 0; i < particleCount; i++) {
            positions[i * 3] += velocities[i * 3];
            positions[i * 3 + 1] += velocities[i * 3 + 1];
            positions[i * 3 + 2] += velocities[i * 3 + 2];
          }
          particles.geometry.attributes.position.needsUpdate = true;
          material.opacity -= 0.02;

          if (material.opacity > 0) {
            requestAnimationFrame(animateParticles);
          } else {
            scene.remove(particles);
          }
        };
        animateParticles();
      }

      function showResultModal(data) {
        currentState = STATE.RESULT;
        updateStatus("WINNER FOUND!", "bg-green-500");

        // å¡«å……æ•°æ®
        document.getElementById("winner-name").innerText = data.name;
        document.getElementById("winner-id").innerText = `ID: ${data.id} | ${data.dept}`;

        // ç”Ÿæˆä¸´æ—¶å¤´åƒ URL (å¦‚æœæœ‰çœŸå®å›¾ç‰‡é“¾æ¥å¯æ›¿æ¢)
        // è¿™é‡Œç®€å•ç”¨ä¸€ä¸ªè‰²å—ä»£æ›¿
        const avatar = document.getElementById("winner-avatar");
        avatar.style.backgroundColor = data.avatarColor;
        avatar.src =
          "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjMwIiByPSIyMCIgZmlsbD0id2hpdGUiIG9wYWNpdHk9IjAuOCIvPjxwYXRoIGQ9Ik0yMCA5MCBRNTAgNTAgODAgOTAiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjgiLz48L3N2Zz4=";

        // æ˜¾ç¤º
        modal.classList.remove("hidden");
        setTimeout(() => {
          modalCard.classList.remove("scale-95", "opacity-0");
          modalCard.classList.add("scale-100", "opacity-100");
        }, 50);
      }

      // å…³é—­ç»“æœï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡
      window.closeResult = function () {
        modalCard.classList.remove("scale-100", "opacity-100");
        modalCard.classList.add("scale-95", "opacity-0");

        setTimeout(() => {
          modal.classList.add("hidden");
          resetState();
        }, 300);
      };

      function resetState() {
        // æ¢å¤ç›¸æœº
        resetCamera();

        // æ¢å¤å¡ç‰‡çŠ¶æ€ (å¦‚æœæœ‰ç¼©æ”¾çš„)
        cards.forEach((c) => {
          c.scale.set(1, 1, 1);
          c.children = []; // ç§»é™¤å…‰æ™•
        });

        // æ¢å¤ UI
        btnStart.classList.remove("hidden");
        btnPause.classList.add("hidden");
        btnStop.classList.add("hidden");
        btnPause.innerHTML = "â¸ æš‚åœ";

        currentState = STATE.IDLE;
        updateStatus("READY", "bg-green-500");
      }

      window.resetCamera = function () {
        new TWEEN.Tween(camera.position)
          .to({ x: 0, y: 0, z: 1200 }, 1500)
          .easing(TWEEN.Easing.Quadratic.InOut)
          .onUpdate(() => {
            camera.lookAt(0, 0, 0);
          })
          .start();
      };

      window.toggleFullScreen = function () {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      };

      // å¯åŠ¨
      init();
    </script>
  </body>
</html>
