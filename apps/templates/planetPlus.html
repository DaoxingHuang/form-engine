<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é²¸æ¢å››å‘¨å¹´åˆ›ä½œè€…å±•ç¤º (20,000äººç‰ˆ)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- å¼•å…¥ TWEEN.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <style>
      /* --- æ ¸å¿ƒé¢œè‰²å˜é‡ --- */
      :root {
        --color-primary: #ff6b6b;
        --color-secondary: #4834d4;
        --bg-dark: #000008;
        --modal-bg: #1a1a2e;
        --glow-color-1: #ff7eb3;
        --glow-color-2: #42c2ff;
        --glow-color-3: #9d7be8;
      }

      body {
        margin: 0;
        overflow: hidden;
        background-color: var(--bg-dark);
        font-family: "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }

      #canvas-container {
        width: 100vw;
        height: 100vh;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      }

      .interactive {
        pointer-events: auto;
      }

      /* ç»ç’ƒé¢æ¿åŸºç¡€ */
      .glass-panel {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
      }

      /* å·¦ä¸Šè§’ä¿¡æ¯é¢æ¿ */
      .vi-info-panel {
        background: #111827;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }

      .vi-title-gradient {
        background: linear-gradient(90deg, #1dd1a1 0%, #a685e6 50%, #ff6b6b 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        font-weight: 900;
        letter-spacing: 1px;
      }

      /* --- æŒ‰é’®æ ·å¼ä¼˜åŒ– --- */

      /* 1. å¼€å§‹æŒ‰é’® */
      .btn-lottery-primary {
        background: linear-gradient(90deg, #ff7eb3 0%, #a685e6 50%, #1dd1a1 100%);
        color: white;
        box-shadow: 0 8px 25px rgba(255, 126, 179, 0.4);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .btn-lottery-primary:hover {
        background: linear-gradient(90deg, #1dd1a1 0%, #a685e6 50%, #ff7eb3 100%);
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 12px 35px rgba(72, 52, 212, 0.6);
      }
      .btn-lottery-primary:active {
        transform: scale(0.98);
      }

      /* 2. åœæ­¢å¹¶èšç„¦æŒ‰é’® (çº¢æ©™è‰²ç³») */
      .btn-lottery-stop {
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        color: white;
        box-shadow: 0 8px 25px rgba(255, 75, 43, 0.4);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .btn-lottery-stop:hover {
        background: linear-gradient(135deg, #ff4b2b 0%, #ff416c 100%);
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 12px 35px rgba(255, 65, 108, 0.6);
      }
      .btn-lottery-stop:active {
        transform: scale(0.98);
      }

      /* 3. æš‚åœæŒ‰é’® */
      .btn-lottery-pause {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #e5e7eb;
        transition: all 0.2s;
      }
      .btn-lottery-pause:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }

      /* --- å¼¹çª—æ ·å¼ --- */
      @keyframes rotate-border {
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes pulse-ring {
        0%,
        100% {
          opacity: 0.5;
          filter: blur(10px);
        }
        50% {
          opacity: 0.8;
          filter: blur(15px);
        }
      }

      .winner-modal-card {
        background: var(--modal-bg);
        border-radius: 20px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        color: white;
      }

      .winner-modal-card::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(
          transparent,
          var(--glow-color-1),
          var(--glow-color-2),
          var(--glow-color-3),
          transparent 30%
        );
        animation: rotate-border 4s linear infinite;
        opacity: 0.5;
      }

      .card-inner-mask {
        position: relative;
        z-index: 1;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(5px);
        border-radius: 18px;
        height: calc(100% - 4px);
        width: calc(100% - 4px);
        margin: 2px;
        padding: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .avatar-ring-glow {
        position: absolute;
        inset: -5px;
        border-radius: 50%;
        background: linear-gradient(45deg, var(--glow-color-1), var(--glow-color-2), var(--glow-color-3));
        animation: pulse-ring 2s infinite;
        z-index: -1;
      }

      .modal-enter-bounce {
        transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      .modal-title-gradient {
        background: linear-gradient(45deg, var(--glow-color-2), var(--glow-color-1));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      .vibrant-modal-card {
        display: flex;
        flex-direction: column;
        max-height: 95vh;
      }
      .settings-scroll-content {
        overflow-y: auto;
        width: 100%;
        flex-grow: 1;
      }
    </style>
  </head>
  <body>
    <!-- 3D å®¹å™¨ -->
    <div id="canvas-container"></div>

    <!-- UI äº¤äº’å±‚ -->
    <div class="absolute top-0 left-0 w-full h-full z-10 p-6 flex flex-col justify-between">
      <!-- é¡¶éƒ¨ä¿¡æ¯ -->
      <div class="flex justify-between items-start">
        <div class="vi-info-panel p-4 text-white interactive">
          <h1 class="text-3xl vi-title-gradient mb-1">é²¸æ¢å››å‘¨å¹´</h1>
          <div class="text-sm text-gray-400 mt-1 flex items-center gap-2">
            <span>åˆ›ä½œè€…å±•ç¤º | å‚ä¸äººæ•°:</span>
            <span id="user-count" class="text-cyan-300 font-bold font-mono text-lg">0</span>
          </div>
          <div class="mt-2 flex items-center gap-2">
            <div id="status-dot" class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
            <span id="status-text" class="text-sm font-semibold text-gray-300">å°±ç»ª (IDLE)</span>
          </div>
        </div>
      </div>

      <!-- åº•éƒ¨æ§åˆ¶æ  -->
      <div class="flex justify-center items-end pb-8 relative w-full">
        <!-- ä¸­å¤®æ§åˆ¶åŒº -->
        <div class="glass-panel px-3 py-3 rounded-full flex gap-3 interactive items-center backdrop-blur-xl">
          <!-- 1. å¯åŠ¨æŒ‰é’® -->
          <button
            id="btn-start"
            class="btn-lottery-primary font-bold py-3 px-8 rounded-full flex items-center gap-2 text-lg"
          >
            <span class="text-2xl">ğŸš€</span> å¯åŠ¨å±•ç¤º
          </button>

          <!-- 2. æš‚åœæŒ‰é’® -->
          <button
            id="btn-pause"
            class="btn-lottery-pause font-medium py-3 px-6 rounded-full flex items-center gap-2 hidden"
          >
            â¸ æš‚åœ
          </button>

          <!-- 3. åœæ­¢å¹¶èšç„¦æŒ‰é’® -->
          <button
            id="btn-stop"
            class="btn-lottery-stop font-bold py-3 px-8 rounded-full flex items-center gap-2 hidden shadow-lg"
          >
            <span class="text-xl">ğŸ›‘</span> åœæ­¢å¹¶èšç„¦
          </button>

          <!-- é‡ç½®è§†è§’å°æŒ‰é’®çš„å·¦ä¾§åˆ†éš”çº¿ -->
          <div id="control-separator" class="w-px h-8 bg-white/10 mx-1 transition-opacity duration-300"></div>

          <button
            onclick="resetViewOnly()"
            class="w-10 h-10 rounded-full flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition"
            title="é‡ç½®è§†è§’"
          >
            â†º
          </button>
        </div>

        <!-- å³ä¸‹è§’ï¼šè®¾ç½®ä¸å…¨å± (ç»å¯¹å®šä½) -->
        <div class="absolute bottom-6 right-0 glass-panel p-2 rounded-full flex gap-2 interactive">
          <button
            class="w-10 h-10 rounded-full hover:bg-white/20 flex items-center justify-center text-white text-xl"
            onclick="showSettingsModal()"
            title="è®¾ç½®"
          >
            âš™
          </button>
          <button
            class="w-10 h-10 rounded-full hover:bg-white/20 flex items-center justify-center text-white text-xl"
            onclick="toggleFullScreen()"
            title="å…¨å±"
          >
            â›¶
          </button>
        </div>
      </div>
    </div>

    <!-- ç»“æœå¼¹çª— -->
    <div
      id="result-modal"
      class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-md"
    >
      <div class="winner-modal-card max-w-sm w-full mx-4 rounded-xl transform scale-0 opacity-0" id="result-card">
        <div class="card-inner-mask">
          <button onclick="closeResult()" class="absolute top-4 right-4 text-gray-500 hover:text-white transition z-20">
            âœ•
          </button>

          <div class="px-3 py-1 bg-yellow-600/20 text-yellow-300 text-xs font-semibold rounded-full mb-4">å‘¨å¹´æ„Ÿè°¢</div>
          <h2 class="text-3xl modal-title-gradient tracking-tight font-extrabold">é²¸æ¢åˆ›ä½œè€…</h2>
          <p class="text-xs text-gray-400 tracking-widest uppercase mb-6">æ„Ÿè°¢æœ‰ä½ </p>

          <div class="relative w-28 h-28 mb-6 mx-auto">
            <div class="avatar-ring-glow"></div>
            <div class="relative w-full h-full rounded-full p-1 bg-gray-900 border border-gray-700 z-10">
              <img id="winner-avatar" src="" class="w-full h-full rounded-full object-cover bg-gray-800" />
            </div>
          </div>

          <div class="mb-6 text-center">
            <h3 id="winner-name" class="text-2xl font-bold mb-1 text-white">ç”¨æˆ·å</h3>
            <p id="winner-id" class="text-sm text-gray-400 font-mono">ID: 888888</p>
          </div>

          <div class="w-full bg-gray-800/50 rounded-xl p-3 border border-gray-700/50 flex items-center gap-3 mb-6">
            <span class="text-2xl">ğŸ’–</span>
            <div class="text-white text-sm font-medium">æ„Ÿè°¢æ‚¨ä¸ºå¹³å°å¸¦æ¥çš„ç‹¬ç‰¹ä»·å€¼</div>
          </div>

          <div class="grid grid-cols-2 gap-3 w-full border-t border-white/10 pt-4">
            <button
              id="btn-auto-next"
              class="py-3 rounded-lg text-sm font-medium bg-gray-700/50 text-gray-400 transition cursor-default"
            >
              <span id="auto-countdown-text">ç­‰å¾…ä¸­...</span>
            </button>
            <button
              onclick="manualStartNextRound()"
              class="btn-lottery-primary py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2"
            >
              ä¸‹ä¸€è½® â†’
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div
      id="settings-modal"
      class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-md opacity-0 transition-opacity duration-300"
    >
      <div
        class="vibrant-modal-card max-w-xl w-full mx-4 bg-[#111827] border border-gray-700 rounded-xl transform scale-95 transition-transform"
        id="settings-card"
      >
        <h2 class="text-2xl font-bold p-6 border-b border-gray-700 text-white">âš™ è®¾ç½®</h2>

        <div class="settings-scroll-content p-6 space-y-6">
          <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
            <label class="text-sm font-medium text-gray-300">å±•ç¤ºç»“æŸåè‡ªåŠ¨å¼€å§‹ä¸‹ä¸€è½®</label>
            <input type="checkbox" id="autoStartNextRoundToggle" class="h-5 w-5 accent-cyan-500" />
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1"
              >è‡ªåŠ¨å¼€å§‹å»¶è¿Ÿ (<span id="autoStartDelayValue" class="text-cyan-400">2</span>ç§’)</label
            >
            <input
              type="range"
              id="autoStartDelay"
              min="1"
              max="10"
              step="1"
              class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1"
              >å±•ç¤ºæŒç»­æ—¶é—´ (<span id="spinDurationValue" class="text-cyan-400">3</span>ç§’)</label
            >
            <input
              type="range"
              id="spinDuration"
              min="1"
              max="10"
              step="1"
              class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>

          <!-- å¸¸è§„è®¾ç½® -->
          <div>
            <label class="block text-sm text-gray-400 mb-1"
              >æ˜Ÿçƒå¡ç‰‡æ•°é‡ (<span id="cardCountValue" class="text-cyan-400">200</span>)</label
            >
            <input
              type="range"
              id="cardCount"
              min="50"
              max="500"
              step="10"
              class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1"
              >æ—‹è½¬é€Ÿåº¦ (<span id="spinSpeedMaxValue" class="text-cyan-400">0.08</span>)</label
            >
            <input
              type="range"
              id="spinSpeedMax"
              min="0.01"
              max="0.2"
              step="0.01"
              class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>

          <hr class="border-gray-700" />
          <div>
            <label class="block text-sm text-gray-400 mb-1"
              >è½®æ¢é—´éš” (ç§’) (<span id="swapIntervalValue" class="text-cyan-400">5</span>)</label
            >
            <input
              type="range"
              id="swapInterval"
              min="1"
              max="10"
              step="1"
              class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1"
              >å•æ¬¡è½®æ¢æ•°é‡ (<span id="swapCountValue" class="text-cyan-400">20</span>)</label
            >
            <input
              type="range"
              id="swapCount"
              min="5"
              max="50"
              step="5"
              class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>

          <!-- æ–°å¢ï¼šç²’å­æ•°é‡è®¾ç½® -->
          <div>
            <label class="block text-sm text-gray-400 mb-1"
              >èƒŒæ™¯ç²’å­æ•°é‡ (<span id="particleCountValue" class="text-cyan-400">1000</span>)</label
            >
            <input
              type="range"
              id="particleCount"
              min="100"
              max="3000"
              step="100"
              class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>

          <!-- æ–°å¢ï¼šå¡ç‰‡å¤–è§‚é…ç½® -->
          <div class="pt-4 border-t border-gray-700">
            <h3 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider">å¡ç‰‡å¤–è§‚é…ç½®</h3>

            <div class="mb-4">
              <label class="block text-sm text-gray-400 mb-1"
                >å¡ç‰‡å°ºå¯¸ç¼©æ”¾ (<span id="cardScaleValue" class="text-cyan-400">1.0</span>x)</label
              >
              <input
                type="range"
                id="cardScale"
                min="0.5"
                max="2.0"
                step="0.1"
                class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
              />
            </div>

            <div class="mb-4">
              <label class="block text-sm text-gray-400 mb-1"
                >å¤´åƒå¤§å°ç³»æ•° (<span id="avatarSizeValue" class="text-cyan-400">1.0</span>x)</label
              >
              <input
                type="range"
                id="avatarSize"
                min="0.5"
                max="1.3"
                step="0.1"
                class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
              />
            </div>

            <!-- æ–°å¢ï¼šæ˜µç§°å­—å· -->
            <div class="mb-4">
              <label class="block text-sm text-gray-400 mb-1"
                >æ˜µç§°å­—ä½“å¤§å° (<span id="nicknameFontSizeValue" class="text-cyan-400">30</span>px)</label
              >
              <input
                type="range"
                id="nicknameFontSize"
                min="20"
                max="60"
                step="1"
                class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
              />
            </div>

            <div class="mb-2">
              <label class="block text-sm text-gray-400 mb-1"
                >æ˜µç§°æœ€å¤§æ˜¾ç¤ºé•¿åº¦ (<span id="nicknameLimitValue" class="text-cyan-400">6</span>å­—)</label
              >
              <input
                type="range"
                id="nicknameLimit"
                min="3"
                max="12"
                step="1"
                class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
              />
            </div>
          </div>
        </div>

        <div class="p-4 border-t border-gray-700 flex justify-end gap-3">
          <button onclick="hideSettingsModal()" class="px-4 py-2 rounded text-gray-400 hover:text-white transition">
            å–æ¶ˆ
          </button>
          <button onclick="saveSettingsHandler()" class="btn-lottery-primary px-6 py-2 rounded font-bold text-sm">
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- é…ç½®ä¸æ•°æ® ---
      const CARD_THEME_COLORS = [
        { border: "#42C2FF", background: "#254E70" },
        { border: "#B762FE", background: "#6A3B9E" },
        { border: "#C1FF72", background: "#709E3B" },
        { border: "#FF85E1", background: "#A14E87" }
      ];

      const INITIAL_CONFIG = {
        cardCount: 200, // æ˜Ÿçƒä¸ŠåŒæ—¶æ˜¾ç¤ºçš„å¡ç‰‡æ•°é‡
        radius: 600,
        cardWidth: 60,
        cardHeight: 35,
        spinSpeedMax: 0.08,
        autoStartNextRound: true,
        autoStartDelay: 2000,
        spinDuration: 3000,
        totalUsers: 20000,
        swapInterval: 5000,
        swapCount: 20,
        particleCount: 1000,
        particleSpeedMax: 10,
        // æ–°å¢é…ç½®é¡¹
        cardScale: 1.0, // å¡ç‰‡æ•´ä½“ç¼©æ”¾
        avatarSize: 1.0, // å¤´åƒå¤§å°ç³»æ•°
        nicknameLimit: 6, // æ˜µç§°æœ€å¤§é•¿åº¦
        nicknameFontSize: 30 // æ˜µç§°å­—ä½“å¤§å°
      };
      let CONFIG = { ...INITIAL_CONFIG };

      const STATE = { IDLE: 0, SPINNING: 2, PAUSED: 3, STOPPING: 4, RESULT: 5 };
      let currentState = STATE.IDLE;

      let scene,
        camera,
        renderer,
        planetGroup = new THREE.Group();
      let cards = [],
        particles;
      let currentSpinSpeed = 0;
      let autoTimeout = null,
        autoCountdownInterval = null,
        swapIntervalRef = null;
      let fullUserList;
      let nextUserIndex = CONFIG.cardCount; // æŒ‡å‘ fullUserList ä¸­ä¸‹ä¸€ä¸ªå¾…ä¸Šåœºçš„ç”¨æˆ·ç´¢å¼•

      // æ¨¡æ‹Ÿæ•°æ®æº
      const CUSTOM_USERS_DATA = [
        {
          name: "è¯5915",
          avatarUrl: "https://gw.alipayobjects.com/mdn/rms_47f090/afts/img/A*ti0gQIRkBd0AAAAAAAAAAAAAARQnAQ"
        },
        { name: "é˜¿è›‹å„¿å¯Œè´µ", avatarUrl: "https://tfs.alipayobjects.com/images/partner/T13.hXXcXXXXXXXXXX" },
        { name: "è—å®¶_1ox6qjc9PM", avatarUrl: "https://tfs.alipayobjects.com/images/partner/T1.a4nXoVfXXXXXXXX" },
        {
          name: "é“å¾·ç»ç›‘ç£æ£€æŸ¥",
          avatarUrl: "https://tfs.alipayobjects.com/images/partner/TB1ErIUb_0yDuNjHv_OXXbBlVXa"
        },
        {
          name: "è´°æŒæŸœ",
          avatarUrl: "https://gw.alipayobjects.com/mdn/rms_47f090/afts/img/A*ti0gQIRkBd0AAAAAAAAAAAAAARQnAQ"
        },
        {
          name: "ç²¾å‡†å‡ºå‡»",
          avatarUrl:
            "https://mdn.alipayobjects.com/afts/img/A*XnYCS6RXZ8AAAAAATZAAAAgAAQAAAQ/original?bz=mm_other&tid=afts_traceId"
        },
        {
          name: "å˜‰å½§å ‚",
          avatarUrl: "https://gw.alipayobjects.com/mdn/rms_47f090/afts/img/A*ti0gQIRkBd0AAAAAAAAAAAAAARQnAQ"
        },
        { name: "å°çŒªçµ®çµ®", avatarUrl: "https://tfs.alipayobjects.com/images/partner/TB1COWIcP9EDuNjmgXUXXbCKXXa" }
      ];

      // ç”Ÿæˆ 20,000 ä¸ªç”¨æˆ·æ•°æ®
      function generateUsers(count) {
        const users = [];
        for (let i = 0; i < count; i++) {
          const template = CUSTOM_USERS_DATA[i % CUSTOM_USERS_DATA.length];
          // ç”Ÿæˆå”¯ä¸€ ID
          const uid = (1322000000000000 + i).toString();
          users.push({
            id: uid,
            name: i < CUSTOM_USERS_DATA.length ? template.name : `${template.name}_${i}`, // ç¨å¾®å˜ä½“åå­—ä»¥å…å®Œå…¨é‡å¤
            avatarUrl: template.avatarUrl
          });
        }
        return users;
      }

      // --- åˆå§‹åŒ– ---
      function init() {
        loadSettings();
        fullUserList = generateUsers(CONFIG.totalUsers);

        // é‡ç½®æŒ‡é’ˆï¼Œé˜²æ­¢é…ç½®å˜æ›´åæº¢å‡º
        nextUserIndex = CONFIG.cardCount;

        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x0f172a, 0.0008);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 5000);
        camera.position.z = 1200;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById("canvas-container").appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const pl = new THREE.PointLight(0x1dd1a1, 1, 2000);
        pl.position.set(500, 500, 500);
        scene.add(pl);

        createPlanetCards();
        createStarfield();
        createMovingParticles();

        initSettingsUI();
        window.addEventListener("resize", () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });

        startSwapping();
        document.getElementById("user-count").innerText = CONFIG.totalUsers.toLocaleString();

        // åˆå§‹ UI çŠ¶æ€æ£€æŸ¥
        updateControlLayout();

        animate();

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById("btn-start").onclick = startSpinning;
        document.getElementById("btn-pause").onclick = togglePause;
        document.getElementById("btn-stop").onclick = stopLottery;
      }

      function updateControlLayout() {
        const btnStart = document.getElementById("btn-start");
        const btnPause = document.getElementById("btn-pause");
        const btnStop = document.getElementById("btn-stop");
        const separator = document.getElementById("control-separator");

        // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ§åˆ¶æŒ‰é’®å¯è§
        const hasVisibleButtons =
          !btnStart.classList.contains("hidden") ||
          !btnPause.classList.contains("hidden") ||
          !btnStop.classList.contains("hidden");

        if (hasVisibleButtons) {
          separator.classList.remove("opacity-0", "w-0", "mx-0");
          separator.classList.add("w-px", "mx-1");
        } else {
          separator.classList.add("opacity-0", "w-0", "mx-0");
          separator.classList.remove("w-px", "mx-1");
        }
      }

      // --- 3D å¯¹è±¡åˆ›å»º ---
      function createCardTexture(user) {
        const canvas = document.createElement("canvas");
        canvas.width = 256;
        canvas.height = 140;
        const ctx = canvas.getContext("2d");
        const theme = CARD_THEME_COLORS[Math.floor(Math.random() * CARD_THEME_COLORS.length)];

        // èƒŒæ™¯
        ctx.fillStyle = theme.background;
        ctx.strokeStyle = theme.border;
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.roundRect(5, 5, 246, 130, 15);
        ctx.fill();
        ctx.stroke();

        // --- åŠ¨æ€å¸ƒå±€è®¡ç®— ---
        // é»˜è®¤åŠå¾„35ï¼Œæ ¹æ® CONFIG.avatarSize ç¼©æ”¾
        const baseRadius = 35;
        const avatarRadius = baseRadius * CONFIG.avatarSize;
        const avatarX = 60; // åœ†å¿ƒXå›ºå®š
        const avatarY = 70; // åœ†å¿ƒYå›ºå®š

        // ç»˜åˆ¶å¤´åƒ (åœ†å½¢)
        ctx.beginPath();
        ctx.arc(avatarX, avatarY, avatarRadius, 0, Math.PI * 2);
        ctx.fillStyle = "#444";
        ctx.fill();
        ctx.stroke();

        // æ–‡å­—ç»˜åˆ¶ - åŠ¨æ€è®¡ç®—èµ·å§‹Xåæ ‡ï¼Œé˜²æ­¢è¢«å¤§å¤´åƒé®æŒ¡
        // é»˜è®¤æ–‡å­—åœ¨ X=110ï¼Œå¦‚æœå¤´åƒå˜å¤§ï¼Œæ–‡å­—èµ·å§‹ç‚¹å‘å³æ¨ç§»
        const safeTextMargin = 15;
        const textStartX = Math.max(110, avatarX + avatarRadius + safeTextMargin);

        ctx.textAlign = "left"; // ç¡®ä¿å·¦å¯¹é½
        // åº”ç”¨é…ç½®çš„å­—ä½“å¤§å°
        ctx.fillStyle = "#fff";
        ctx.font = `bold ${CONFIG.nicknameFontSize}px Arial`;

        let name = user.name;
        // å¼ºåˆ¶æˆªæ–­é€»è¾‘
        if (name.length > CONFIG.nicknameLimit) {
          name = name.substring(0, CONFIG.nicknameLimit) + "...";
        }
        ctx.fillText(name, textStartX, 60);

        ctx.fillStyle = "#1DD1A1";
        ctx.font = "20px Arial";
        ctx.fillText(`ID: ${user.id.slice(0, 2)}***${user.id.slice(-4)}`, textStartX, 95);

        const tex = new THREE.CanvasTexture(canvas);
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = () => {
          ctx.save();
          ctx.beginPath();
          ctx.arc(avatarX, avatarY, avatarRadius, 0, Math.PI * 2);
          ctx.clip();
          // å›¾ç‰‡ç»˜åˆ¶åŒºåŸŸéœ€è¦è¦†ç›–æ•´ä¸ªåœ†
          ctx.drawImage(img, avatarX - avatarRadius, avatarY - avatarRadius, avatarRadius * 2, avatarRadius * 2);
          ctx.restore();
          // é‡ç»˜æè¾¹
          ctx.beginPath();
          ctx.arc(avatarX, avatarY, avatarRadius, 0, Math.PI * 2);
          ctx.stroke();
          tex.needsUpdate = true;
        };
        img.src = user.avatarUrl;
        return tex;
      }

      function createPlanetCards() {
        cards.forEach((c) => planetGroup.remove(c));
        planetGroup.clear();
        cards = [];

        const coreGeo = new THREE.SphereGeometry(CONFIG.radius - 20, 32, 32);
        // å°†ä¸é€æ˜åº¦ä» 0.9 æ”¹ä¸º 0.05ï¼Œå®ç°é€æ˜æ•ˆæœ
        planetGroup.add(
          new THREE.Mesh(
            coreGeo,
            new THREE.MeshBasicMaterial({ color: 0x1e293b, transparent: true, opacity: 0.05, side: THREE.BackSide })
          )
        );
        planetGroup.add(
          new THREE.Mesh(
            coreGeo,
            new THREE.MeshBasicMaterial({ color: 0x4834d4, wireframe: true, transparent: true, opacity: 0.2 })
          )
        );
        scene.add(planetGroup);

        const phi = Math.PI * (3 - Math.sqrt(5));
        const users = fullUserList.slice(0, CONFIG.cardCount);

        users.forEach((user, i) => {
          const y = 1 - (i / (users.length - 1)) * 2;
          const r = Math.sqrt(1 - y * y);
          const theta = phi * i;
          const pos = new THREE.Vector3(Math.cos(theta) * r, y, Math.sin(theta) * r).multiplyScalar(CONFIG.radius);

          // åº”ç”¨å¡ç‰‡å°ºå¯¸ç¼©æ”¾é…ç½® CONFIG.cardScale
          const card = new THREE.Mesh(
            new THREE.PlaneGeometry(CONFIG.cardWidth * CONFIG.cardScale, CONFIG.cardHeight * CONFIG.cardScale),
            new THREE.MeshBasicMaterial({ map: createCardTexture(user), side: THREE.DoubleSide, transparent: true })
          );
          card.position.copy(pos);
          // è®©å¡ç‰‡é¢å‘å¤–éƒ¨ (ä¹˜ä»¥2çš„å‘é‡æŒ‡å‘å¤–éƒ¨)
          card.lookAt(pos.clone().multiplyScalar(2));

          card.userData = { id: user.id, data: user };
          planetGroup.add(card);
          cards.push(card);
        });
      }

      function createStarfield() {
        const geo = new THREE.BufferGeometry();
        const pos = [];
        for (let i = 0; i < 1500; i++)
          pos.push(
            THREE.MathUtils.randFloatSpread(4000),
            THREE.MathUtils.randFloatSpread(4000),
            THREE.MathUtils.randFloatSpread(4000)
          );
        geo.setAttribute("position", new THREE.Float32BufferAttribute(pos, 3));
        scene.add(new THREE.Points(geo, new THREE.PointsMaterial({ color: 0x888899, size: 2 })));
      }

      function createMovingParticles() {
        if (particles) scene.remove(particles);
        const geo = new THREE.BufferGeometry();
        const pos = [],
          colors = [],
          sizes = [],
          vels = [];
        const theme = [new THREE.Color(0xff6b6b), new THREE.Color(0x1dd1a1), new THREE.Color(0xffd700)];

        for (let i = 0; i < CONFIG.particleCount; i++) {
          pos.push((Math.random() - 0.5) * 4000, (Math.random() - 0.5) * 4000, (Math.random() - 0.5) * 1000);
          const c = theme[Math.floor(Math.random() * 3)];
          colors.push(c.r, c.g, c.b);
          sizes.push(Math.random() * 8 + 4);
          vels.push((Math.random() - 0.5) * 5, (Math.random() - 0.5) * 5, 0);
        }
        geo.setAttribute("position", new THREE.Float32BufferAttribute(pos, 3));
        geo.setAttribute("color", new THREE.Float32BufferAttribute(colors, 3));
        geo.setAttribute("size", new THREE.Float32BufferAttribute(sizes, 1));
        geo.userData = { vels };

        particles = new THREE.Points(
          geo,
          new THREE.PointsMaterial({ size: 9, vertexColors: true, transparent: true, blending: THREE.AdditiveBlending })
        ); // åŸºç¡€å°ºå¯¸æ”¹ä¸º9
        scene.add(particles);
      }

      // --- åŠ¨ç”»å¾ªç¯ ---
      function animate(time) {
        requestAnimationFrame(animate);
        TWEEN.update(time);

        if (currentState === STATE.SPINNING) currentSpinSpeed = CONFIG.spinSpeedMax;
        else if (currentState === STATE.IDLE) currentSpinSpeed = 0.002;
        else currentSpinSpeed = 0;

        if (currentState !== STATE.RESULT) {
          planetGroup.rotation.y -= currentSpinSpeed;
          // æ³¨æ„ï¼šæ­¤å¤„ä¸å†ä¿®æ”¹ rotation.xï¼Œä»¥é˜²æ­¢å¹²æ‰°åœæ­¢æ—¶çš„ä¿¯ä»°é”å®š
        }

        // ç²’å­è¿åŠ¨
        if (particles) {
          const pos = particles.geometry.attributes.position.array;
          const vels = particles.geometry.userData.vels;
          for (let i = 0; i < CONFIG.particleCount; i++) {
            pos[i * 3] += vels[i * 3] * 0.1;
            pos[i * 3 + 1] += vels[i * 3 + 1] * 0.1;
            if (pos[i * 3] > 2000) pos[i * 3] = -2000;
            if (pos[i * 3 + 1] > 2000) pos[i * 3 + 1] = -2000;
          }
          particles.geometry.attributes.position.needsUpdate = true;
        }
        renderer.render(scene, camera);
      }

      // --- æ ¸å¿ƒå‡çº§ï¼šå®æ—¶æ•°æ®è½®è½¬é€»è¾‘ ---
      function startSwapping() {
        if (swapIntervalRef) clearInterval(swapIntervalRef);
        swapIntervalRef = setInterval(() => {
          // ä»…åœ¨ç©ºé—²æˆ–æ—‹è½¬æ—¶æ›´æ–°æ•°æ®ï¼Œé¿å…åœ¨å¼€å¥–/ç»“æœå±•ç¤ºæ—¶çªå…€å˜åŒ–
          if (currentState !== STATE.IDLE && currentState !== STATE.SPINNING) return;

          updatePlanetDataBatch();
        }, CONFIG.swapInterval);
      }

      function updatePlanetDataBatch() {
        // æ¯æ¬¡è½®æ¢ CONFIG.swapCount å¼ å¡ç‰‡
        const countToSwap = CONFIG.swapCount;

        for (let i = 0; i < countToSwap; i++) {
          // 1. éšæœºé€‰æ‹©æ˜Ÿçƒä¸Šçš„ä¸€å¼ å¡ç‰‡è¿›è¡Œæ›¿æ¢ (éšæœºæ˜¾å¾—æ›´è‡ªç„¶ï¼Œä¸åƒæ˜¯ä¸€ä¸ªæ‰«æçº¿)
          const cardIndex = Math.floor(Math.random() * cards.length);
          const card = cards[cardIndex];

          // 2. è·å–é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªæ–°ç”¨æˆ·
          const newUser = fullUserList[nextUserIndex];

          // 3. æ˜¾å¼é”€æ¯æ—§çº¹ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ (å…³é”®!)
          if (card.material.map) {
            card.material.map.dispose();
          }

          // 4. åˆ›å»ºæ–°çº¹ç†å¹¶åº”ç”¨
          card.material.map = createCardTexture(newUser);
          card.userData.data = newUser; // æ›´æ–°ç»‘å®šçš„æ•°æ®ï¼Œç¡®ä¿ä¸­å¥–æ—¶æ˜¯æ–°ç”¨æˆ·
          card.userData.id = newUser.id;

          // 5. ç§»åŠ¨æŒ‡é’ˆ (å¾ªç¯é˜Ÿåˆ—æ ¸å¿ƒ)
          nextUserIndex = (nextUserIndex + 1) % fullUserList.length;
        }
        // console.log(`[System] Swapped ${countToSwap} users. Next index: ${nextUserIndex}`);
      }

      // --- é€»è¾‘æ§åˆ¶ ---
      function startSpinning() {
        if (currentState === STATE.SPINNING) return;
        currentState = STATE.SPINNING;
        updateStatus("å±•ç¤ºè¿›è¡Œä¸­...", "bg-red-500");

        // æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€æ›´æ–°
        document.getElementById("btn-start").classList.add("hidden");
        document.getElementById("btn-pause").classList.remove("hidden");
        document.getElementById("btn-stop").classList.remove("hidden");
        document.getElementById("btn-pause").innerHTML = "â¸ æš‚åœ";

        updateControlLayout();

        // è‡ªåŠ¨åœæ­¢é€»è¾‘
        setTimeout(() => {
          if (currentState === STATE.SPINNING) stopLottery();
        }, CONFIG.spinDuration);
      }

      function togglePause() {
        if (currentState === STATE.SPINNING) {
          currentState = STATE.PAUSED;
          document.getElementById("btn-pause").innerHTML = "â–¶ ç»§ç»­";
          updateStatus("å·²æš‚åœ", "bg-yellow-600");
        } else if (currentState === STATE.PAUSED) {
          currentState = STATE.SPINNING;
          document.getElementById("btn-pause").innerHTML = "â¸ æš‚åœ";
          updateStatus("å±•ç¤ºè¿›è¡Œä¸­...", "bg-red-500");
        }
      }

      function stopLottery() {
        if (currentState === STATE.STOPPING || currentState === STATE.RESULT) return;
        currentState = STATE.STOPPING;
        document.getElementById("btn-pause").classList.add("hidden");
        document.getElementById("btn-stop").classList.add("hidden");

        updateControlLayout();

        updateStatus("æ­£åœ¨èšç„¦...", "bg-purple-500");

        // 1. é€‰å‡ºä¸­å¥–è€…
        const winner = cards[Math.floor(Math.random() * cards.length)];
        const targetPos = winner.position.clone(); // å±€éƒ¨åæ ‡

        // 2. åŒè½´é”å®šè®¡ç®— (Dual-Axis Locking)
        // A. æ°´å¹³æ—‹è½¬ (Yè½´): å°†ç›®æ ‡å¯¹å‡† Z è½´æ­£æ–¹å‘
        const angleY = Math.atan2(targetPos.x, targetPos.z);
        let targetY = -angleY;
        const currentY = planetGroup.rotation.y;
        const TWO_PI = Math.PI * 2;
        // ç¡®ä¿å¤šè½¬å‡ åœˆä¸”å¹³æ»‘è¡”æ¥
        while (targetY > currentY) targetY -= TWO_PI;
        targetY -= TWO_PI * 2;

        // B. å‚ç›´ä¿¯ä»° (Xè½´): å°†ç›®æ ‡ç§»åŠ¨åˆ°èµ¤é“å¹³é¢ (Y=0)
        // è®¡ç®—ç›®æ ‡ç‚¹åœ¨å±€éƒ¨åæ ‡ç³»ä¸­çš„çº¬åº¦è§’
        // å¦‚æœ targetPos.y > 0 (åŒ—åŠçƒ)ï¼Œæˆ‘ä»¬éœ€è¦è®©æ˜Ÿçƒä½å¤´ (Rotation X æ­£å‘å¢åŠ )
        const radiusProjected = Math.sqrt(targetPos.x * targetPos.x + targetPos.z * targetPos.z);
        const angleX = Math.atan2(targetPos.y, radiusProjected);
        // ç›®æ ‡æ˜¯è®©è¯¥ç‚¹è½¬åˆ° Y=0ï¼Œæ‰€ä»¥éœ€è¦è½¬åŠ¨çš„è§’åº¦å°±æ˜¯å®ƒçš„çº¬åº¦
        const targetX = angleX;

        // 3. å¯åŠ¨åŒè½´æ—‹è½¬
        // ä½¿ç”¨ TWEEN åŒæ—¶æ”¹å˜ X å’Œ Y è½´æ—‹è½¬
        new TWEEN.Tween(planetGroup.rotation)
          .to({ y: targetY, x: targetX }, 3000)
          .easing(TWEEN.Easing.Cubic.Out)
          .onComplete(() => {
            // 4. ç§»åŠ¨æ‘„åƒæœºèšç„¦ (ä¿æŒæ‘„åƒæœºæ°´å¹³ï¼Œå› ä¸ºæ˜Ÿçƒå·²ç»è‡ªé€‚åº”æ—‹è½¬äº†)
            const camTarget = new THREE.Vector3(0, 0, 850);
            new TWEEN.Tween(camera.position)
              .to({ x: 0, y: 0, z: 850 }, 1000)
              .easing(TWEEN.Easing.Quadratic.Out)
              .onComplete(() => {
                currentState = STATE.RESULT;
                highlightCard(winner);
                setTimeout(() => showResultModal(winner.userData.data), 500);
              })
              .start();
          })
          .start();
      }

      function highlightCard(card) {
        // 1. æ”¾å¤§ (Scale Up) - å¼¹æ€§æ•ˆæœ - å¢åŠ å›è§’ï¼ˆBack easingï¼‰
        // æ³¨æ„ï¼šåŸºäºé…ç½®çš„ scale è¿›è¡Œæ”¾å¤§
        const baseScale = CONFIG.cardScale;

        // æ­¥éª¤1: å¿«é€Ÿæ”¾å¤§è¿‡å¤´
        new TWEEN.Tween(card.scale)
          .to({ x: baseScale * 1.5, y: baseScale * 1.5, z: baseScale * 1.5 }, 600)
          .easing(TWEEN.Easing.Back.Out) // ä½¿ç”¨ Back.Out äº§ç”Ÿå›å¼¹æ•ˆæœ
          .start();

        // 2. å‘å…‰èƒŒæ¿ (Glow Background)
        // å°ºå¯¸ä¹Ÿéœ€è¦åŸºäº cardScale è°ƒæ•´
        const glowGeo = new THREE.PlaneGeometry(
          CONFIG.cardWidth * CONFIG.cardScale * 1.25,
          CONFIG.cardHeight * CONFIG.cardScale * 1.25
        );
        const glowMat = new THREE.MeshBasicMaterial({
          color: 0x00ffff, // Cyan glow
          transparent: true,
          opacity: 0.6,
          blending: THREE.AdditiveBlending,
          side: THREE.DoubleSide
        });
        const glow = new THREE.Mesh(glowGeo, glowMat);
        glow.position.z = -1; // Behind
        card.add(glow);

        // 3. å‘¼å¸åŠ¨ç”» (Breathing Glow)
        new TWEEN.Tween(glowMat).to({ opacity: 0.2 }, 800).yoyo(true).repeat(Infinity).start();

        new TWEEN.Tween(glow.scale).to({ x: 1.15, y: 1.15 }, 800).yoyo(true).repeat(Infinity).start();

        // 4. ä¸€æ¬¡æ€§é—ªå…‰ (Flash)
        const flashGeo = new THREE.PlaneGeometry(
          CONFIG.cardWidth * CONFIG.cardScale * 1.5,
          CONFIG.cardHeight * CONFIG.cardScale * 1.5
        );
        const flashMat = new THREE.MeshBasicMaterial({
          color: 0xffffff,
          transparent: true,
          opacity: 0.9,
          blending: THREE.AdditiveBlending
        });
        const flash = new THREE.Mesh(flashGeo, flashMat);
        flash.position.z = 1;
        card.add(flash);
        new TWEEN.Tween(flashMat)
          .to({ opacity: 0 }, 500)
          .onComplete(() => card.remove(flash))
          .start();
      }

      function showResultModal(data) {
        const modal = document.getElementById("result-modal");
        const card = document.getElementById("result-card");

        document.getElementById("winner-name").innerText = data.name;
        document.getElementById("winner-id").innerText = `ID: ${data.id.slice(0, 2)}***${data.id.slice(-4)}`;
        document.getElementById("winner-avatar").src = data.avatarUrl;

        modal.classList.remove("hidden");
        card.classList.remove("scale-0", "opacity-0");
        card.classList.add("modal-enter-bounce", "scale-100", "opacity-100");

        // è‡ªåŠ¨å€’è®¡æ—¶
        if (CONFIG.autoStartNextRound) {
          let left = CONFIG.autoStartDelay / 1000;
          const btnText = document.getElementById("auto-countdown-text");
          btnText.innerText = `è‡ªåŠ¨å¼€å§‹ (${left}s)`;

          clearInterval(autoCountdownInterval);
          autoCountdownInterval = setInterval(() => {
            left--;
            if (left > 0) btnText.innerText = `è‡ªåŠ¨å¼€å§‹ (${left}s)`;
            else clearInterval(autoCountdownInterval);
          }, 1000);

          clearTimeout(autoTimeout);
          autoTimeout = setTimeout(() => {
            closeResult(true); // è‡ªåŠ¨è§¦å‘å¹¶ä¼ é€’ true
          }, CONFIG.autoStartDelay);
        } else {
          document.getElementById("auto-countdown-text").innerText = "ç­‰å¾…æ‰‹åŠ¨æ“ä½œ";
        }
      }

      window.manualStartNextRound = () => closeResult(true);
      window.closeResult = (autoStart = false) => {
        clearTimeout(autoTimeout);
        clearInterval(autoCountdownInterval);
        const modal = document.getElementById("result-modal");
        const card = document.getElementById("result-card");

        card.classList.remove("modal-enter-bounce", "scale-100", "opacity-100");
        card.classList.add("scale-0", "opacity-0");

        setTimeout(() => {
          modal.classList.add("hidden");
          resetState(autoStart);
        }, 300);
      };

      /**
       * æ ¸å¿ƒé€»è¾‘ï¼šå®‰å…¨å¤ä½ä¸è‡ªåŠ¨é‡å¯
       */
      function resetState(andStartNext) {
        currentState = STATE.STOPPING;
        updateStatus("å¤ä½ä¸­...", "bg-gray-500");

        // éšè—æ§åˆ¶æŒ‰é’®
        document.getElementById("btn-pause").classList.add("hidden");
        document.getElementById("btn-stop").classList.add("hidden");
        document.getElementById("btn-pause").innerHTML = "â¸ æš‚åœ";

        updateControlLayout();

        // æ¸…ç†å¡ç‰‡ç‰¹æ•ˆ
        cards.forEach((c) => {
          // å¹³æ»‘æ¢å¤å¤§å° (æ¢å¤åˆ°é…ç½®çš„ scale)
          new TWEEN.Tween(c.scale).to({ x: 1, y: 1, z: 1 }, 500).start();
          // ç§»é™¤æ‰€æœ‰å­å…ƒç´ ï¼ˆå…‰æ•ˆã€èƒŒæ¿ç­‰ï¼‰
          for (let i = c.children.length - 1; i >= 0; i--) {
            c.remove(c.children[i]);
          }
        });

        // 1. å¤ä½æ‘„åƒæœº
        const resetCameraPromise = new Promise((resolve) => {
          new TWEEN.Tween(camera.position)
            .to({ x: 0, y: 0, z: 1200 }, 1500)
            .easing(TWEEN.Easing.Quadratic.InOut)
            .onUpdate(() => camera.lookAt(0, 0, 0))
            .onComplete(resolve)
            .start();
        });

        // 2. å¤ä½æ˜Ÿçƒè§’åº¦ (åŒ…æ‹¬ X è½´å’Œ Y è½´)
        const resetPlanetPromise = new Promise((resolve) => {
          new TWEEN.Tween(planetGroup.rotation)
            .to({ x: 0, y: 0 }, 1200) // åŒæ—¶å¤ä½ä¿¯ä»°è§’å’Œæ°´å¹³è§’
            .easing(TWEEN.Easing.Quadratic.Out)
            .onComplete(resolve)
            .start();
        });

        // 3. ç­‰å¾…å…¨éƒ¨å¤ä½å®Œæˆåï¼Œå†æ‰§è¡Œä¸‹ä¸€æ­¥
        Promise.all([resetCameraPromise, resetPlanetPromise]).then(() => {
          currentState = STATE.IDLE;
          updateStatus("å°±ç»ª (IDLE)", "bg-green-500");

          if (andStartNext && CONFIG.autoStartNextRound) {
            startSpinning(); // åªæœ‰å®Œå…¨å¤ä½åï¼Œæ‰å¼€å§‹ä¸‹ä¸€è½®
          } else {
            document.getElementById("btn-start").classList.remove("hidden");
            updateControlLayout();
          }
        });
      }

      window.resetViewOnly = () => {
        new TWEEN.Tween(camera.position).to({ x: 0, y: 0, z: 1200 }, 1500).easing(TWEEN.Easing.Quadratic.InOut).start();
        new TWEEN.Tween(planetGroup.rotation).to({ x: 0 }, 1500).easing(TWEEN.Easing.Quadratic.InOut).start(); // åŒæ—¶ä¹Ÿå¤ä½æ˜Ÿçƒä¿¯ä»°
      };

      function updateStatus(text, color) {
        document.getElementById("status-text").innerText = text;
        document.getElementById("status-dot").className = `w-2.5 h-2.5 rounded-full ${color}`;
      }

      // --- è®¾ç½®é¢æ¿é€»è¾‘ ---
      function initSettingsUI() {
        const ids = [
          "cardCount",
          "spinSpeedMax",
          "autoStartDelay",
          "spinDuration",
          "swapInterval",
          "swapCount",
          "cardScale",
          "avatarSize",
          "nicknameLimit",
          "nicknameFontSize",
          "particleCount"
        ];
        const spans = [
          "cardCountValue",
          "spinSpeedMaxValue",
          "autoStartDelayValue",
          "spinDurationValue",
          "swapIntervalValue",
          "swapCountValue",
          "cardScaleValue",
          "avatarSizeValue",
          "nicknameLimitValue",
          "nicknameFontSizeValue",
          "particleCountValue"
        ];

        ids.forEach((id, i) => {
          const el = document.getElementById(id);
          if (!el) return;

          const sp = document.getElementById(spans[i]);
          if (!sp) return;

          // ä» CONFIG åŠ è½½é»˜è®¤å€¼
          if (id === "cardCount") el.value = CONFIG.cardCount;
          if (id === "spinSpeedMax") el.value = CONFIG.spinSpeedMax;
          if (id === "autoStartDelay") el.value = CONFIG.autoStartDelay / 1000;
          if (id === "spinDuration") el.value = CONFIG.spinDuration / 1000;
          if (id === "swapInterval") el.value = CONFIG.swapInterval / 1000;
          if (id === "swapCount") el.value = CONFIG.swapCount;
          if (id === "cardScale") el.value = CONFIG.cardScale;
          if (id === "avatarSize") el.value = CONFIG.avatarSize;
          if (id === "nicknameLimit") el.value = CONFIG.nicknameLimit;
          if (id === "nicknameFontSize") el.value = CONFIG.nicknameFontSize;
          if (id === "particleCount") el.value = CONFIG.particleCount;

          sp.innerText = el.value;
          el.oninput = (e) => (sp.innerText = e.target.value);
        });
        const toggle = document.getElementById("autoStartNextRoundToggle");
        if (toggle) toggle.checked = CONFIG.autoStartNextRound;
      }

      window.showSettingsModal = () => {
        const m = document.getElementById("settings-modal");
        m.classList.remove("hidden");
        setTimeout(() => m.classList.remove("opacity-0"), 10);
      };
      window.hideSettingsModal = () => {
        const m = document.getElementById("settings-modal");
        m.classList.add("opacity-0");
        setTimeout(() => m.classList.add("hidden"), 300);
      };
      window.saveSettingsHandler = () => {
        CONFIG.cardCount = +document.getElementById("cardCount").value;
        CONFIG.spinSpeedMax = +document.getElementById("spinSpeedMax").value;
        CONFIG.autoStartDelay = +document.getElementById("autoStartDelay").value * 1000;
        CONFIG.spinDuration = +document.getElementById("spinDuration").value * 1000;
        CONFIG.swapInterval = +document.getElementById("swapInterval").value * 1000;
        CONFIG.swapCount = +document.getElementById("swapCount").value;
        CONFIG.autoStartNextRound = document.getElementById("autoStartNextRoundToggle").checked;

        // æ–°å¢é…ç½®ä¿å­˜
        CONFIG.cardScale = +document.getElementById("cardScale").value;
        CONFIG.avatarSize = +document.getElementById("avatarSize").value;
        CONFIG.nicknameLimit = +document.getElementById("nicknameLimit").value;
        CONFIG.nicknameFontSize = +document.getElementById("nicknameFontSize").value;
        CONFIG.particleCount = +document.getElementById("particleCount").value;

        createPlanetCards(); // é‡å»ºæ˜Ÿçƒåº”ç”¨æ–°å¤–è§‚
        createMovingParticles(); // é‡å»ºç²’å­
        startSwapping(); // é‡å¯è½®æ¢è®¡æ—¶å™¨
        saveSettings();
        hideSettingsModal();
        alertMessage("è®¾ç½®å·²ä¿å­˜", "bg-green-500");
      };

      function saveSettings() {
        localStorage.setItem("lotteryConfig_v3", JSON.stringify(CONFIG));
      }
      function loadSettings() {
        const s = localStorage.getItem("lotteryConfig_v3");
        if (s) CONFIG = { ...CONFIG, ...JSON.parse(s) };
      }
      function alertMessage(msg, color) {
        updateStatus(msg, color);
        setTimeout(() => updateStatus("å°±ç»ª", "bg-green-500"), 2000);
      }
      window.toggleFullScreen = () =>
        !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen();

      window.onload = init;
    </script>
  </body>
</html>
