<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D æŠ½å¥–æ˜Ÿçƒ (Lottery Planet)</title>
    <!-- å¼•å…¥ Tailwind CSS è¿›è¡Œå¿«é€Ÿ UI æ ·å¼å¼€å‘ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- å¼•å…¥ TWEEN.js ç”¨äºå¹³æ»‘åŠ¨ç”» -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #050510;
        font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }
      #canvas-container {
        width: 100vw;
        height: 100vh;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      }

      /* UI å±‚çº§åœ¨ Canvas ä¹‹ä¸Š */
      #ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none;
      }
      .interactive {
        pointer-events: auto;
      }

      /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ - åŸºç¡€ç‰ˆ */
      .glass-panel {
        background: rgba(20, 30, 60, 0.4);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
      }

      /* å€’è®¡æ—¶åŠ¨ç”» */
      @keyframes pulse-scale {
        0% {
          transform: scale(0.8);
          opacity: 0;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 0;
        }
      }
      .countdown-anim {
        animation: pulse-scale 0.8s ease-out forwards;
      }

      /* éœ“è™¹å‘å…‰æ–‡å­— */
      .neon-text {
        text-shadow:
          0 0 10px rgba(0, 255, 255, 0.7),
          0 0 20px rgba(0, 255, 255, 0.5);
      }

      /* --- å‘¨å¹´åº†ä¸»é¢˜æ ·å¼ --- */

      /* ç¼å¸¦æ¸å˜æ–‡å­— */
      .ribbon-text {
        background: linear-gradient(135deg, #a8ff78 0%, #78ffd6 25%, #ff7eb3 50%, #f6d365 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        font-weight: 800;
      }

      /* å¼¹çª—å¡ç‰‡èƒŒæ™¯ - æ¨¡ä»¿å›¾ç‰‡çš„æµå…‰æ„Ÿ */
      .anniversary-card {
        background: rgba(10, 10, 25, 0.85);
        border-radius: 24px;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow:
          0 20px 50px rgba(0, 0, 0, 0.5),
          0 0 30px rgba(120, 255, 214, 0.2);
      }

      /* åŠ¨æ€æµå…‰è¾¹æ¡† */
      .anniversary-card::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(transparent, #ff7eb3, #78ffd6, #f6d365, transparent 30%);
        animation: rotate-border 4s linear infinite;
        z-index: 0;
        opacity: 0.5;
      }

      /* å†…éƒ¨é®ç½©ï¼Œç”¨äºæ˜¾ç¤ºè¾¹æ¡† */
      .card-inner {
        position: relative;
        z-index: 1;
        background: #0f1016; /* æ·±è‰²èƒŒæ™¯è¡¬æ‰˜å¤šå½©æ–‡å­— */
        border-radius: 22px;
        height: calc(100% - 4px);
        width: calc(100% - 4px);
        margin: 2px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      @keyframes rotate-border {
        100% {
          transform: rotate(360deg);
        }
      }

      /* è£…é¥°æ€§çš„èƒŒæ™¯æ•°å­— "4" */
      .bg-deco-number {
        position: absolute;
        font-size: 200px;
        font-weight: 900;
        top: -40px;
        right: -20px;
        background: linear-gradient(135deg, rgba(246, 211, 101, 0.1), rgba(255, 126, 179, 0.1));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        z-index: 0;
        pointer-events: none;
        font-family: "Arial Black", sans-serif;
        transform: rotate(10deg);
      }

      /* æŒ‰é’®æ¸å˜ - å‘¼åº”å›¾ç‰‡è‰²è°ƒ */
      .btn-gradient-theme {
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
      }
      .btn-gradient-theme:hover {
        background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
        box-shadow: 0 0 15px rgba(0, 242, 254, 0.5);
      }

      /* è‡ªåŠ¨ç»§ç»­æŒ‰é’®æ ·å¼ */
      .btn-auto-next {
        background-color: #1f2937;
        color: #d1d5db;
      }

      /* å¼¹çª—å…¥åœºå¼¹æ€§åŠ¨ç”» */
      .modal-enter-bounce {
        transition: all 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
    </style>
  </head>
  <body>
    <!-- 3D å®¹å™¨ -->
    <div id="canvas-container"></div>

    <!-- UI äº¤äº’å±‚ -->
    <div id="ui-layer" class="flex flex-col justify-between p-6">
      <!-- é¡¶éƒ¨ï¼šçŠ¶æ€æ  -->
      <div class="flex justify-between items-start">
        <div class="glass-panel p-4 rounded-xl text-white interactive">
          <h1 class="text-2xl font-bold ribbon-text">LOTTERY PLANET</h1>
          <div class="text-xs text-gray-400 mt-1">
            4å‘¨å¹´åº†å…¸ç‰ˆ | å‚ä¸äººæ•°: <span id="user-count" class="text-cyan-300">0</span>
          </div>
          <div class="mt-2 flex items-center gap-2">
            <div id="status-dot" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span id="status-text" class="text-sm font-mono text-gray-300">READY</span>
          </div>
        </div>

        <div class="glass-panel p-2 rounded-lg flex gap-2 interactive">
          <button class="p-2 hover:bg-white/10 rounded text-gray-300 text-xs" title="è®¾ç½®">âš™ï¸</button>
          <button class="p-2 hover:bg-white/10 rounded text-gray-300 text-xs" title="å…¨å±" onclick="toggleFullScreen()">
            â›¶
          </button>
        </div>
      </div>

      <!-- ä¸­å¿ƒï¼šå€’è®¡æ—¶æ˜¾ç¤º -->
      <div
        id="countdown-display"
        class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-9xl font-black text-white hidden z-50 neon-text"
      >
        3
      </div>

      <!-- åº•éƒ¨ï¼šæ§åˆ¶æ  -->
      <div class="flex justify-center items-end pb-8">
        <div class="glass-panel px-6 py-4 rounded-full flex gap-4 interactive items-center">
          <!-- å¼€å§‹/æŠ½å¥–æŒ‰é’® -->
          <button
            id="btn-start"
            class="bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 hover:from-pink-400 hover:via-purple-400 hover:to-cyan-400 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105 active:scale-95 flex items-center gap-2 border border-white/20"
          >
            <span class="text-xl">âœ¨</span> å¼€å¯å¥½è¿ (è‡ªåŠ¨è½®è®­)
          </button>

          <!-- æš‚åœ/ç»§ç»­ -->
          <button
            id="btn-pause"
            class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow transition hidden"
          >
            â¸ æš‚åœ
          </button>

          <!-- åœæ­¢/è·³è¿‡ -->
          <button
            id="btn-stop"
            class="bg-red-600/80 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-full shadow transition hidden border border-red-400/30"
          >
            â¹ åœæ­¢ & å¼€å¥–
          </button>

          <div class="w-px h-8 bg-gray-600 mx-2"></div>
          <button onclick="resetCamera()" class="text-gray-400 hover:text-white text-sm">é‡ç½®è§†è§’</button>
        </div>
      </div>
    </div>

    <!-- ç»“æœå¼¹çª— (Theme: 4th Anniversary Ribbon) -->
    <div
      id="result-modal"
      class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm"
    >
      <!-- å¤–å±‚å®¹å™¨è´Ÿè´£æ—‹è½¬æµå…‰è¾¹æ¡† -->
      <!-- åˆå§‹çŠ¶æ€ä¸º scale-0 opacity-0ï¼Œé€šè¿‡ JS åŠ¨æ€åº”ç”¨ bounce åŠ¨ç”» -->
      <div class="anniversary-card max-w-md w-full mx-4 transform scale-0 opacity-0" id="result-card">
        <!-- å†…å®¹å®¹å™¨ -->
        <div class="card-inner p-8 relative overflow-hidden">
          <!-- èƒŒæ™¯è£…é¥°å¤§æ•°å­— "4" -->
          <div class="bg-deco-number">4</div>

          <!-- é¡¶éƒ¨ Logo/æ ‡é¢˜ -->
          <div class="text-center mb-6 z-10 relative">
            <div
              class="inline-block px-3 py-1 rounded-full border border-yellow-500/30 bg-yellow-500/10 text-yellow-300 text-xs tracking-widest mb-2"
            >
              ANNIVERSARY
            </div>
            <h2 class="text-4xl font-black ribbon-text tracking-tight">æ­å–œä¸­å¥–!</h2>
            <p class="text-gray-400 text-sm mt-1">LUCKY WINNER</p>
          </div>

          <!-- å¤´åƒåŒºåŸŸ -->
          <div class="relative flex justify-center mb-6 z-10">
            <!-- åŠ¨æ€å…‰ç¯ -->
            <div
              class="absolute inset-0 bg-gradient-to-r from-cyan-400 to-pink-500 rounded-full blur-xl opacity-40 animate-pulse w-32 h-32 mx-auto top-[-10px]"
            ></div>
            <div class="relative p-1 rounded-full bg-gradient-to-tr from-yellow-300 via-pink-500 to-cyan-400">
              <img
                id="winner-avatar"
                src=""
                class="w-28 h-28 rounded-full border-4 border-[#0f1016] object-cover bg-gray-800"
              />
            </div>
          </div>

          <!-- è·å¥–è€…ä¿¡æ¯ -->
          <div class="text-center mb-8 z-10 relative">
            <h3 id="winner-name" class="text-3xl text-white font-bold mb-1 drop-shadow-md">Unknown</h3>
            <p
              id="winner-id"
              class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300 font-mono"
            >
              ID: 888888
            </p>
          </div>

          <!-- å¥–å“å¡ç‰‡ -->
          <div class="bg-white/5 border border-white/10 rounded-xl p-4 mb-8 relative z-10 backdrop-blur-sm">
            <div class="flex items-center gap-3">
              <div class="text-3xl">ğŸ</div>
              <div class="text-left">
                <p class="text-gray-400 text-xs uppercase">Prize</p>
                <p class="text-lg font-bold text-white leading-tight">4å‘¨å¹´é™å®šç¥ç§˜å¤§ç¤¼åŒ…</p>
              </div>
            </div>
          </div>

          <!-- åº•éƒ¨æŒ‰é’® -->
          <div class="grid grid-cols-2 gap-4 relative z-10">
            <!-- è‡ªåŠ¨è½®è®­å€’è®¡æ—¶æ˜¾ç¤º -->
            <button
              id="btn-auto-next"
              class="btn-auto-next border border-white/20 text-gray-300 py-3 rounded-xl transition text-sm font-medium cursor-default"
            >
              <span id="auto-countdown-text">5ç§’åè‡ªåŠ¨å¼€å§‹ä¸‹ä¸€è½®</span>
            </button>
            <!-- ç«‹å³å¼€å§‹ä¸‹ä¸€è½®æŒ‰é’® -->
            <button
              onclick="manualStartNextRound()"
              class="btn-gradient-theme text-white py-3 rounded-xl transition font-bold shadow-lg flex justify-center items-center gap-2 text-sm"
            >
              <span class="text-lg">â–¶ï¸</span> ç«‹å³å¼€å§‹ä¸‹ä¸€è½®
            </button>
          </div>

          <!-- å…³é—­æŒ‰é’® -->
          <button
            onclick="manualCloseModal()"
            class="absolute top-4 right-4 text-gray-500 hover:text-white z-20 transition transform hover:rotate-90"
          >
            âœ•
          </button>
        </div>
      </div>
    </div>

    <script>
      /**
       * 1. åˆå§‹åŒ–ä¸é…ç½®
       */
      const CONFIG = {
        cardCount: 200, // æ˜Ÿçƒä¸Šçš„å¡ç‰‡æ•°é‡ (N)
        radius: 600, // æ˜ŸçƒåŠå¾„
        cardWidth: 60, // å¡ç‰‡å®½åº¦
        cardHeight: 35, // å¡ç‰‡é«˜åº¦
        spinSpeedMax: 0.08, // æœ€å¤§æ—‹è½¬é€Ÿåº¦
        spinAccel: 0.001, // åŠ é€Ÿåº¦
        spinDecel: 0.0005, // å‡é€Ÿåº¦
        autoNextRoundDelay: 5000, // å¼€å¥–åå›ºå®šç­‰å¾…æ—¶é—´ (5000ms = 5ç§’)
        totalUsers: 2000, // æ€»å‚ä¸äººæ•° (æ–°å¢)
        swapInterval: 6000 // ç”¨æˆ·åå•è½®æ¢é—´éš” (6ç§’) (æ–°å¢)
      };

      const STATE = {
        IDLE: 0,
        COUNTDOWN: 1,
        SPINNING: 2,
        PAUSED: 3,
        STOPPING: 4,
        RESULT: 5
      };

      let currentState = STATE.IDLE;
      let scene, camera, renderer;
      let planetGroup = new THREE.Group();
      let cards = [];
      let currentSpinSpeed = 0;

      let autoTimeout = null; // ç”¨äºæ§åˆ¶è‡ªåŠ¨å¼€å§‹ä¸‹ä¸€è½®çš„ setTimeout å¼•ç”¨
      let autoCountdownInterval = null; // ç”¨äºæ§åˆ¶å¼¹çª—å€’è®¡æ—¶çš„ setInterval å¼•ç”¨
      let swapIntervalRef = null; // ç”¨äºç”¨æˆ·åå•è½®æ¢çš„ setInterval å¼•ç”¨ (æ–°å¢)
      let fullUserList; // å­˜å‚¨æ‰€æœ‰ 2000 åå‚ä¸è€…çš„åˆ—è¡¨ (æ–°å¢)

      // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
      const generateUsers = (count) => {
        const users = [];
        const depts = ["æŠ€æœ¯éƒ¨", "è®¾è®¡éƒ¨", "è¿è¥éƒ¨", "äº§å“éƒ¨", "å¸‚åœºéƒ¨"];
        for (let i = 0; i < count; i++) {
          users.push({
            id: 1000 + i,
            name: `U_${Math.floor(Math.random() * 9000) + 1000}`,
            dept: depts[Math.floor(Math.random() * depts.length)],
            avatarColor: `hsl(${Math.random() * 360}, 70%, 60%)`
          });
        }
        return users;
      };
      // ç«‹å³ç”Ÿæˆå®Œæ•´çš„ç”¨æˆ·åˆ—è¡¨
      fullUserList = generateUsers(CONFIG.totalUsers);

      /**
       * 2. çº¹ç†ç”Ÿæˆ - åˆ›å»ºå¸¦å¤´åƒå›¾æ ‡çš„çŸ©å½¢å¡ç‰‡çº¹ç†
       */
      function createCardTexture(user) {
        const canvas = document.createElement("canvas");
        canvas.width = 256; // çº¹ç†å°ºå¯¸
        canvas.height = 140;
        const ctx = canvas.getContext("2d");

        // 1. ç»˜åˆ¶çŸ©å½¢å¡ç‰‡èƒŒæ™¯ (æ¸å˜è‰²)
        const gradient = ctx.createLinearGradient(0, 0, 256, 140);
        gradient.addColorStop(0, "rgba(20, 30, 80, 0.9)");
        gradient.addColorStop(1, "rgba(40, 10, 60, 0.9)");

        ctx.fillStyle = gradient;
        ctx.strokeStyle = "rgba(100, 200, 255, 0.3)";
        ctx.lineWidth = 4;

        ctx.beginPath();
        ctx.roundRect(5, 5, 246, 130, 15);
        ctx.fill();
        ctx.stroke();

        // 2. ç»˜åˆ¶åœ†å½¢å¤´åƒåŒºåŸŸ (èƒŒæ™¯è‰²)
        const avatarX = 60;
        const avatarY = 70;
        const avatarRadius = 35;

        ctx.beginPath();
        ctx.arc(avatarX, avatarY, avatarRadius, 0, Math.PI * 2);
        ctx.fillStyle = user.avatarColor; // ç”¨æˆ·çš„ä¸“å±é¢œè‰²
        ctx.fill();
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 3;
        ctx.stroke();

        // 3. åœ¨åœ†å½¢åŒºåŸŸç»˜åˆ¶ä¸€ä¸ªç™½è‰²ç”¨æˆ·å›¾æ ‡ (æ¨¡æ‹Ÿå¤´åƒå›¾ç‰‡)
        ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
        const iconHeadRadius = 12;

        // ç»˜åˆ¶å¤´éƒ¨ (åœ†å½¢)
        ctx.beginPath();
        ctx.arc(avatarX, avatarY - 10, iconHeadRadius, 0, Math.PI * 2);
        ctx.fill();

        // ç»˜åˆ¶èº«ä½“ (å¼§å½¢/åŠåœ†)
        ctx.beginPath();
        ctx.arc(avatarX, avatarY + 15, 20, Math.PI * 1.1, Math.PI * 1.9); // ä»åº•éƒ¨ç•¥å¾®å‘ä¸Šå¼¯æ›²çš„å¼§
        ctx.fill();

        // 4. ç»˜åˆ¶æ–‡å­—ä¿¡æ¯
        ctx.fillStyle = "#ffffff";
        ctx.font = "bold 36px Arial";
        ctx.fillText(user.name, 110, 70);

        ctx.fillStyle = "#aaddff";
        ctx.font = "24px Arial";
        ctx.fillText(user.dept, 110, 105);

        const texture = new THREE.CanvasTexture(canvas);
        return texture;
      }

      /**
       * 3. Three.js åœºæ™¯æ„å»º (è¿˜åŸå¡ç‰‡å‡ ä½•ä½“)
       */
      function init() {
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050510, 0.0008);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 5000);
        camera.position.z = 1200;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById("canvas-container").appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const pointLight = new THREE.PointLight(0x00ffff, 1, 2000);
        pointLight.position.set(500, 500, 500);
        scene.add(pointLight);

        // æ˜Ÿçƒæ ¸å¿ƒ
        const coreGeometry = new THREE.SphereGeometry(CONFIG.radius - 20, 32, 32);
        const coreMaterial = new THREE.MeshBasicMaterial({
          color: 0x001133,
          transparent: true,
          opacity: 0.8,
          wireframe: true
        });
        const core = new THREE.Mesh(coreGeometry, coreMaterial);
        planetGroup.add(core);

        const phi = Math.PI * (3 - Math.sqrt(5));

        // åˆå§‹åŒ–å¡ç‰‡å‡ ä½•ä½ç½®ï¼Œå¹¶ä½¿ç”¨ fullUserList çš„ç¬¬ä¸€æ‰¹ç”¨æˆ·
        const visibleUsers = fullUserList.slice(0, CONFIG.cardCount);

        visibleUsers.forEach((user, i) => {
          // ä½¿ç”¨æ–æ³¢é‚£å¥‘çƒä½“åˆ†å¸ƒè®¡ç®—å¡ç‰‡ä½ç½®
          const y = 1 - (i / (visibleUsers.length - 1)) * 2;
          const radiusAtY = Math.sqrt(1 - y * y);
          const theta = phi * i;

          const x = Math.cos(theta) * radiusAtY;
          const z = Math.sin(theta) * radiusAtY;

          const position = new THREE.Vector3(x, y, z).multiplyScalar(CONFIG.radius);

          // ä½¿ç”¨ PlaneGeometry (çŸ©å½¢)
          const geometry = new THREE.PlaneGeometry(CONFIG.cardWidth, CONFIG.cardHeight);
          const material = new THREE.MeshBasicMaterial({
            map: createCardTexture(user),
            side: THREE.DoubleSide,
            transparent: true
          });

          const card = new THREE.Mesh(geometry, material);
          card.position.copy(position);
          card.lookAt(0, 0, 0);
          // å­˜å‚¨å½“å‰ç”¨æˆ·æ•°æ®ï¼Œä»¥ä¾¿åç»­æ›¿æ¢çº¹ç†å’ŒæŠ½å¥–
          card.userData = { id: user.id, data: user, originalPos: position.clone() };

          planetGroup.add(card);
          cards.push(card);
        });

        scene.add(planetGroup);
        createStarfield();

        window.addEventListener("resize", onWindowResize, false);

        // å¯åŠ¨ç”¨æˆ·è½®æ¢æœºåˆ¶å’ŒåŠ¨ç”»
        startSwapping();
        animate();

        document.getElementById("user-count").innerText = CONFIG.totalUsers;
      }

      function createStarfield() {
        const geometry = new THREE.BufferGeometry();
        const vertices = [];
        for (let i = 0; i < 1000; i++) {
          vertices.push(
            THREE.MathUtils.randFloatSpread(4000),
            THREE.MathUtils.randFloatSpread(4000),
            THREE.MathUtils.randFloatSpread(4000)
          );
        }
        geometry.setAttribute("position", new THREE.Float32BufferAttribute(vertices, 3));
        const material = new THREE.PointsMaterial({ color: 0x888888, size: 2 });
        const stars = new THREE.Points(geometry, material);
        scene.add(stars);
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      /**
       * 4. åŠ¨ç”»å¾ªç¯
       */
      function animate(time) {
        requestAnimationFrame(animate);
        TWEEN.update(time);

        if (currentState === STATE.SPINNING) {
          if (currentSpinSpeed < CONFIG.spinSpeedMax) {
            currentSpinSpeed += CONFIG.spinAccel;
          }
        } else if (currentState === STATE.PAUSED) {
          currentSpinSpeed = 0;
        } else if (currentState === STATE.STOPPING) {
          // TWEEN æ­£åœ¨å¤„ç†ç²¾ç¡®åœæ­¢ï¼Œè¿™é‡Œä¸è¿›è¡Œç‰©ç†æ—‹è½¬
          currentSpinSpeed = 0;
        } else {
          currentSpinSpeed = 0.002;
        }

        // åªæœ‰åœ¨éç»“æœçŠ¶æ€æ‰æ—‹è½¬ (STOPPING çŠ¶æ€ç”± TWEEN æ§åˆ¶)
        if (currentState !== STATE.RESULT) {
          planetGroup.rotation.y -= currentSpinSpeed;
          planetGroup.rotation.x = Math.sin(time * 0.0005) * 0.1;
        }

        renderer.render(scene, camera);
      }

      /**
       * 5. äº¤äº’é€»è¾‘
       */
      const btnStart = document.getElementById("btn-start");
      const btnPause = document.getElementById("btn-pause");
      const btnStop = document.getElementById("btn-stop");
      const statusText = document.getElementById("status-text");
      const statusDot = document.getElementById("status-dot");
      const countdownEl = document.getElementById("countdown-display");
      const modal = document.getElementById("result-modal");
      const modalCard = document.getElementById("result-card");
      const autoCountdownText = document.getElementById("auto-countdown-text");

      btnStart.addEventListener("click", () => {
        if (currentState === STATE.IDLE) {
          startCountdown();
        }
      });

      btnPause.addEventListener("click", () => {
        if (currentState === STATE.SPINNING) {
          currentState = STATE.PAUSED;
          updateStatus("PAUSED", "bg-yellow-500");
          btnPause.innerHTML = "â–¶ ç»§ç»­";
        } else if (currentState === STATE.PAUSED) {
          currentState = STATE.SPINNING;
          updateStatus("SPINNING...", "bg-blue-500");
          btnPause.innerHTML = "â¸ æš‚åœ";
        }
      });

      btnStop.addEventListener("click", () => {
        if (currentState === STATE.SPINNING || currentState === STATE.PAUSED) {
          stopLottery();
        }
      });

      function updateStatus(text, colorClass) {
        statusText.innerText = text;
        statusDot.className = `w-2 h-2 rounded-full animate-pulse ${colorClass}`;
      }

      function startCountdown() {
        currentState = STATE.COUNTDOWN;
        updateStatus("PREPARING", "bg-yellow-500");
        btnStart.classList.add("hidden");

        let count = 3;
        countdownEl.classList.remove("hidden");

        const timer = setInterval(() => {
          countdownEl.innerText = count;
          countdownEl.classList.remove("countdown-anim");
          void countdownEl.offsetWidth;
          countdownEl.classList.add("countdown-anim");

          if (count <= 0) {
            clearInterval(timer);
            countdownEl.classList.add("hidden");
            startSpinning();
          }
          count--;
        }, 800);
      }

      function startSpinning() {
        currentState = STATE.SPINNING;
        updateStatus("SPINNING...", "bg-blue-500");
        btnPause.classList.remove("hidden");
        btnStop.classList.remove("hidden");

        new TWEEN.Tween(camera.position).to({ x: 0, y: 0, z: 1200 }, 1000).easing(TWEEN.Easing.Quadratic.Out).start();
      }

      function stopLottery() {
        currentState = STATE.STOPPING;
        updateStatus("LUCKY WINNER...", "bg-purple-500");
        btnPause.classList.add("hidden");
        btnStop.classList.add("hidden");

        // åœ¨å½“å‰å¯è§çš„å¡ç‰‡ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªä½œä¸ºä¸­å¥–è€…
        const winnerIndex = Math.floor(Math.random() * cards.length);
        const winnerCard = cards[winnerIndex];
        const winnerData = winnerCard.userData.data;
        const winnerPos = winnerCard.position.clone();

        // --- ç²¾ç¡®è®¡ç®—æ˜Ÿçƒåœæ­¢çš„æœ€ç»ˆ Y è½´æ—‹è½¬è§’åº¦ï¼Œä½¿ä¸­å¥–å¡ç‰‡æ­£å¯¹ç”¨æˆ· (Z-è½´) ---

        // 1. è®¡ç®—å¡ç‰‡åœ¨ XZ å¹³é¢ä¸Šçš„å½“å‰è§’åº¦ (ç›¸å¯¹äºæ˜Ÿçƒä¸­å¿ƒçš„å±€éƒ¨åæ ‡)
        const targetCardAngle = Math.atan2(winnerPos.x, winnerPos.z);

        // 2. æ˜Ÿçƒç¾¤ç»„çš„å½“å‰ Y è½´æ—‹è½¬
        const currentPlanetRotationY = planetGroup.rotation.y;
        const TWO_PI = Math.PI * 2;
        const extraSpins = 1; // ç¡®ä¿è‡³å°‘æ—‹è½¬ 1 åœˆæ¥ä¿è¯è§†è§‰ä¸Šçš„å‡é€Ÿæ•ˆæœ

        // 3. è®¡ç®—ç›®æ ‡åç§»é‡ (å°†å¡ç‰‡è½¬åˆ° Z-è½´æ‰€éœ€çš„è§’åº¦)
        let targetOffset = -targetCardAngle % TWO_PI;
        if (targetOffset < 0) targetOffset += TWO_PI; // è§„èŒƒåŒ–åˆ° [0, 2*PI]

        // 4. å½“å‰ç¾¤ç»„æ—‹è½¬è§’åº¦çš„ä½™æ•° (è§„èŒƒåŒ–åˆ° [0, 2*PI])
        let currentRemainder = currentPlanetRotationY % TWO_PI;
        if (currentRemainder < 0) currentRemainder += TWO_PI;

        // 5. è®¡ç®—æœ€å°æ—‹è½¬å·®å¼‚ (ç¡®ä¿æ²¿è´Ÿæ–¹å‘æ—‹è½¬ï¼Œå› ä¸º SPINNING æ˜¯è´Ÿæ–¹å‘)
        let rotationDifference = targetOffset - currentRemainder;

        // ç¡®ä¿ rotationDifference ä¸ºè´Ÿå€¼
        if (rotationDifference > 0) {
          rotationDifference -= TWO_PI;
        }

        // 6. æœ€ç»ˆç›®æ ‡æ—‹è½¬è§’åº¦: å½“å‰è§’åº¦ + å·®å¼‚è§’ + é¢å¤–æ—‹è½¬åœˆæ•°
        const finalTargetY = currentPlanetRotationY + rotationDifference - extraSpins * TWO_PI;

        // ç«‹å³åœæ­¢ç‰©ç†æ—‹è½¬ï¼Œäº¤ç»™ Tween å¤„ç†å¹³æ»‘å‡é€Ÿ
        currentSpinSpeed = 0;

        // 7. å¯åŠ¨æ˜Ÿçƒç¾¤ç»„çš„æ—‹è½¬ TWEENï¼Œç²¾ç¡®åœæ­¢åˆ°ç›®æ ‡ä½ç½®
        // TWEEN ç›®æ ‡æ—¶é—´ä¸º 2000ms (2ç§’)
        new TWEEN.Tween(planetGroup.rotation)
          .to({ y: finalTargetY }, 2000)
          .easing(TWEEN.Easing.Exponential.Out)
          .onComplete(() => {
            // æ˜Ÿçƒåœæ­¢ï¼Œç°åœ¨å°†æ‘„åƒæœºç§»è¿‘ï¼Œèšç„¦åˆ°å¡ç‰‡

            // è·å–å¡ç‰‡å½“å‰åœ¨ä¸–ç•Œç©ºé—´ä¸­çš„ä½ç½®ï¼ˆæ­¤æ—¶å®ƒåº”è¯¥æ­£å¥½åœ¨Zè½´è´Ÿæ–¹å‘ä¸Šï¼‰
            const targetPos = winnerCard.getWorldPosition(new THREE.Vector3());
            // æ‘„åƒæœºåœåœ¨æ¯”æ˜ŸçƒåŠå¾„ç•¥è¿œçš„ä½ç½®
            const cameraEndPos = targetPos
              .clone()
              .normalize()
              .multiplyScalar(CONFIG.radius + 200);

            new TWEEN.Tween(camera.position)
              .to({ x: cameraEndPos.x, y: cameraEndPos.y, z: cameraEndPos.z }, 1000)
              .easing(TWEEN.Easing.Quadratic.InOut)
              .onUpdate(() => {
                camera.lookAt(targetPos);
              })
              .onComplete(() => {
                // æ‘„åƒæœºåˆ°ä½åï¼Œå¯åŠ¨é«˜å…‰ç‰¹æ•ˆ (1.5ç§’åå¼¹å‡ºçª—å£)
                highlightWinner(winnerCard);

                setTimeout(() => {
                  showResultModal(winnerData);
                }, 1500);
              })
              .start();
          })
          .start();
      }

      function highlightWinner(card) {
        // ç§»é™¤ç¼©æ”¾åŠ¨ç”»ï¼Œä¿æŒå¡ç‰‡åŸå§‹å¤§å°ï¼Œä»…è¿›è¡Œé«˜å…‰å’Œé—ªçƒ
        // new TWEEN.Tween(card.scale).to({ x: 2.5, y: 2.5 }, 500).easing(TWEEN.Easing.Back.Out).start();

        // 1. çˆ†ç‚¸ç²’å­ (å³æ—¶æ•ˆæœ)
        createExplosion(card.getWorldPosition(new THREE.Vector3()));

        // 2. å¿«é€Ÿå…‰æ™•è„‰å†²
        const glowGeo = new THREE.PlaneGeometry(CONFIG.cardWidth * 1.5, CONFIG.cardHeight * 2.5);
        const glowMat = new THREE.MeshBasicMaterial({
          color: 0xffaa00, // é«˜äº®é¢œè‰²
          transparent: true,
          opacity: 0,
          side: THREE.DoubleSide
        });
        const glow = new THREE.Mesh(glowGeo, glowMat);
        glow.position.z = -1; // ç•¥å¾®åœ¨å¡ç‰‡å‰æ–¹
        card.add(glow);

        // å¿«é€Ÿäº®èµ· (100ms) å¹¶ç¼“æ…¢æ¶ˆå¤± (1400ms)
        new TWEEN.Tween(glowMat)
          .to({ opacity: 0.8 }, 100)
          .onComplete(() => {
            new TWEEN.Tween(glowMat)
              .to({ opacity: 0 }, 1400) // 1.4ç§’æ¸éšï¼Œä¸å¤–éƒ¨å®šæ—¶å™¨æ€»å…± 1.5 ç§’
              .onComplete(() => {
                card.remove(glow); // ç§»é™¤å…‰æ™•ç½‘æ ¼
              })
              .start();
          })
          .start();
      }

      function createExplosion(position) {
        const particleCount = 80;
        const geometry = new THREE.BufferGeometry();
        const positions = [];
        const velocities = [];
        const colors = [];

        const themeColors = [
          new THREE.Color("#ff7eb3"),
          new THREE.Color("#78ffd6"),
          new THREE.Color("#f6d365"),
          new THREE.Color("#ffffff")
        ];

        for (let i = 0; i < particleCount; i++) {
          positions.push(position.x, position.y, position.z);

          velocities.push((Math.random() - 0.5) * 15, (Math.random() - 0.5) * 15, (Math.random() - 0.5) * 15);

          velocities[i * 3 + 1] -= 0.1;

          const color = themeColors[Math.floor(Math.random() * themeColors.length)];
          colors.push(color.r, color.g, color.b);
        }

        geometry.setAttribute("position", new THREE.Float32BufferAttribute(positions, 3));
        geometry.setAttribute("color", new THREE.Float32BufferAttribute(colors, 3));

        const material = new THREE.PointsMaterial({
          size: 6,
          vertexColors: true,
          transparent: true,
          blending: THREE.AdditiveBlending
        });

        const particles = new THREE.Points(geometry, material);
        scene.add(particles);

        const animateParticles = () => {
          const positions = particles.geometry.attributes.position.array;
          for (let i = 0; i < particleCount; i++) {
            positions[i * 3] += velocities[i * 3];
            positions[i * 3 + 1] += velocities[i * 3 + 1];
            positions[i * 3 + 2] += velocities[i * 3 + 2];

            velocities[i * 3 + 1] -= 0.1;
          }
          particles.geometry.attributes.position.needsUpdate = true;
          material.opacity -= 0.015;

          if (material.opacity > 0) {
            requestAnimationFrame(animateParticles);
          } else {
            scene.remove(particles);
          }
        };
        animateParticles();
      }

      /**
       * 6. ç”¨æˆ·åå•è½®æ¢é€»è¾‘ (Paging/Swapping)
       */
      function updatePlanetCards() {
        // åªæœ‰åœ¨æ˜Ÿçƒæ—‹è½¬æˆ–é™æ­¢æ—¶æ‰è¿›è¡Œåå•è½®æ¢
        if (currentState === STATE.STOPPING || currentState === STATE.RESULT || cards.length === 0) {
          return;
        }

        const visibleCount = CONFIG.cardCount;

        // 1. è·å–ä¸‹ä¸€ç»„è¦æ˜¾ç¤ºçš„ç”¨æˆ· (æ€»æ˜¯ä» fullUserList çš„å¼€å¤´å– N ä¸ª)
        const visibleUsers = fullUserList.slice(0, visibleCount);
        const usersToRotate = fullUserList.slice(0, visibleCount); // å³å°†è¢«æ›¿æ¢çš„ç”¨æˆ·
        const remainingUsers = fullUserList.slice(visibleCount); // å‰©ä¸‹çš„ç”¨æˆ·

        // 2. æ›´æ–°å¯è§å¡ç‰‡çš„çº¹ç†å’Œç”¨æˆ·æ•°æ®
        cards.forEach((card, i) => {
          const newUser = visibleUsers[i];

          // é”€æ¯æ—§çº¹ç†ä»¥é‡Šæ”¾å†…å­˜ï¼Œåˆ›å»ºå¹¶åº”ç”¨æ–°çº¹ç†
          const newTexture = createCardTexture(newUser);
          if (card.material.map) card.material.map.dispose();
          card.material.map = newTexture;
          card.material.needsUpdate = true;

          // æ›´æ–° userData
          card.userData.data = newUser;
        });

        // 3. è½®æ¢åˆ—è¡¨: å°†åˆšæ˜¾ç¤ºè¿‡çš„ç”¨æˆ·ç§»åŠ¨åˆ°åˆ—è¡¨æœ«å°¾ (ç¡®ä¿å…¬å¹³è½®è®­)
        fullUserList = [...remainingUsers, ...usersToRotate];
      }

      function startSwapping() {
        // åœæ­¢ä»»ä½•ç°æœ‰çš„å®šæ—¶å™¨
        if (swapIntervalRef) {
          clearInterval(swapIntervalRef);
        }

        // å¯åŠ¨å‘¨æœŸæ€§è½®æ¢
        swapIntervalRef = setInterval(() => {
          // åªæœ‰åœ¨éåœæ­¢å’Œéç»“æœçŠ¶æ€ä¸‹æ‰å…è®¸è½®æ¢ï¼Œç¡®ä¿æŠ½å¥–ç»“æœçš„ç¨³å®šæ€§
          if (currentState !== STATE.STOPPING && currentState !== STATE.RESULT) {
            updatePlanetCards();
          }
        }, CONFIG.swapInterval);
      }

      // 7. è‡ªåŠ¨è½®è®­é€»è¾‘

      function showResultModal(data) {
        currentState = STATE.RESULT;
        updateStatus("WINNER FOUND!", "bg-green-500");

        // åœæ­¢ç”¨æˆ·åå•è½®æ¢ï¼Œç¡®ä¿åå•åœ¨å¼€å¥–åä¸å†å˜åŠ¨
        if (swapIntervalRef) clearInterval(swapIntervalRef);

        document.getElementById("winner-name").innerText = data.name;
        document.getElementById("winner-id").innerText = `ID: ${data.id} | ${data.dept}`;

        const avatar = document.getElementById("winner-avatar");
        avatar.style.backgroundColor = data.avatarColor;
        // ç®€å•çš„ SVG å ä½å¤´åƒï¼Œç”¨äº modal
        avatar.src =
          "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjMwIiByPSIyMCIgZmlsbD0id2hpdGUiIG9wYWNpdHk9IjAuOCIvPjxwYXRoIGQ9Ik0yMCA5MCBRNTAgNTAgODAgOTAiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjgiLz48L3N2ZyUzRQ==";

        // 1. è®¾ç½®åˆå§‹çŠ¶æ€ (scale-0)
        modalCard.classList.remove("modal-enter-bounce");
        modalCard.classList.remove("opacity-0", "scale-100");
        modalCard.classList.add("scale-0"); // è®¾ç½®åˆå§‹ç¼©æ”¾ä¸º 0

        modal.classList.remove("hidden");

        // 2. å»¶è¿Ÿåå¯åŠ¨å¼¹æ€§åŠ¨ç”»åˆ°æœ€ç»ˆçŠ¶æ€ (scale-100)
        setTimeout(() => {
          // åº”ç”¨å¼¹æ€§è¿‡æ¸¡
          modalCard.classList.add("modal-enter-bounce");
          // ç§»åŠ¨åˆ°æœ€ç»ˆçŠ¶æ€
          modalCard.classList.remove("scale-0");
          modalCard.classList.add("scale-100");
        }, 50);

        // 3. è®¾ç½®è‡ªåŠ¨å¼€å§‹ä¸‹ä¸€è½®çš„è®¡æ—¶å™¨
        const delayInSeconds = CONFIG.autoNextRoundDelay / 1000;
        let remaining = delayInSeconds;

        clearTimeout(autoTimeout);
        clearInterval(autoCountdownInterval);

        autoCountdownText.innerText = `${remaining}ç§’åè‡ªåŠ¨å¼€å§‹ä¸‹ä¸€è½®`;
        autoCountdownInterval = setInterval(() => {
          remaining--;
          if (remaining >= 0) {
            autoCountdownText.innerText = `${remaining}ç§’åè‡ªåŠ¨å¼€å§‹ä¸‹ä¸€è½®`;
          }
          if (remaining < 0) {
            clearInterval(autoCountdownInterval);
          }
        }, 1000);

        autoTimeout = setTimeout(() => {
          clearInterval(autoCountdownInterval);
          autoStartNextRound();
        }, CONFIG.autoNextRoundDelay);
      }

      function autoStartNextRound() {
        closeResult(true);
      }

      window.manualStartNextRound = function () {
        clearTimeout(autoTimeout);
        clearInterval(autoCountdownInterval);
        closeResult(true);
      };

      window.manualCloseModal = function () {
        clearTimeout(autoTimeout);
        clearInterval(autoCountdownInterval);
        closeResult(false);
      };

      window.closeResult = function (autoStart = false) {
        // å¯åŠ¨é€€å‡ºåŠ¨ç”»
        modalCard.classList.remove("modal-enter-bounce");
        modalCard.style.transition = "all 0.3s ease-out";

        modalCard.classList.remove("scale-100");
        modalCard.classList.add("scale-0", "opacity-0");

        clearTimeout(autoTimeout);
        clearInterval(autoCountdownInterval);

        setTimeout(() => {
          modal.classList.add("hidden");

          // æ¸…ç†æ‰€æœ‰åŠ¨æ€æ ·å¼ï¼Œæ¢å¤åˆ°åˆå§‹çŠ¶æ€
          modalCard.style.transition = "";
          modalCard.classList.remove("opacity-0");
          modalCard.classList.add("scale-0");

          resetState();

          if (autoStart) {
            startCountdown();
          } else {
            btnStart.classList.remove("hidden");
          }
        }, 300);
      };

      function resetState() {
        resetCamera();

        cards.forEach((c) => {
          c.scale.set(1, 1, 1);
          // ç§»é™¤æ‰€æœ‰åŠ¨æ€æ·»åŠ çš„å­å…ƒç´  (å¦‚é«˜å…‰)
          c.children = [];
        });

        btnPause.classList.add("hidden");
        btnStop.classList.add("hidden");
        btnPause.innerHTML = "â¸ æš‚åœ";

        currentState = STATE.IDLE;
        updateStatus("READY", "bg-green-500");

        // é‡å¯ç”¨æˆ·åå•è½®æ¢
        startSwapping();
      }

      window.resetCamera = function () {
        new TWEEN.Tween(camera.position)
          .to({ x: 0, y: 0, z: 1200 }, 1500)
          .easing(TWEEN.Easing.Quadratic.InOut)
          .onUpdate(() => {
            camera.lookAt(0, 0, 0);
          })
          .start();
      };

      window.toggleFullScreen = function () {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      };

      init();
    </script>
  </body>
</html>
